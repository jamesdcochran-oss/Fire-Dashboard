<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Five Forks Fire Weather Dashboard</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Inline emoji favicon to avoid 404s -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22><text y=%2214%22 font-size=%2214%22>üî•</text></svg>">

  <style>
    :root{
      --bg:#0f172a;--fg:#e2e8f0;--muted:#8aa0bf;--line:#e5e7eb;--accent:#0ea5e9;
      --cardbg:#0f182c;--cardbr:#22314a;--chipbg:#0b1529;--ok:#16a34a;--warn:#f59e0b;--bad:#ef4444;
      --touch:44px;
    }
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    html { scroll-behavior:smooth; }

    /* Layout (desktop grid; mobile reorders so data > map) */
    #app{ display:grid; grid-template-areas:
      'header header'
      'toolbar toolbar'
      'map aside';
      grid-template-columns: 1fr 420px; grid-template-rows: 56px auto 1fr; height:100%; }
    header{ grid-area:header; display:flex; align-items:center; justify-content:space-between; padding:8px 12px; background:var(--bg); color:var(--fg); position:sticky; top:0; z-index:5;}
    header .title{ font-weight:700; letter-spacing:.2px; }
    header .actions{ display:flex; gap:8px; }
    .btn{ border:0; border-radius:12px; padding:10px 12px; background:#1f2937; color:#e5e7eb; cursor:pointer; font-size:13px; text-decoration:none; display:inline-flex; align-items:center; gap:6px; min-height:var(--touch);}
    .btn:hover{ filter:brightness(1.08); }

    /* County cards */
    #toolbar{ grid-area:toolbar; border-bottom:1px solid var(--line); background:#0a0f1d; padding:10px 12px;}
    #overview{ display:grid; gap:10px; grid-template-columns:repeat(2,1fr);}
    @media(min-width:900px){ #overview{ grid-template-columns:repeat(3,1fr);} }
    .ov-card{ background:var(--cardbg); border:1px solid var(--cardbr); border-radius:14px; padding:12px; color:#d7e3f7; display:flex; align-items:center; justify-content:space-between; gap:10px; min-height:76px; cursor:pointer;}
    .ov-card:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; }
    .ov-main{ display:grid; gap:4px; }
    .ov-name{ font-weight:700; letter-spacing:.2px; }
    .ov-line{ font-size:13px; color:#b9c9e3; }

    /* Map + Aside */
    #map{ grid-area:map; height:100%; width:100%; }
    aside{ grid-area:aside; border-left:1px solid var(--line); overflow-y:auto; }
    .panel{ padding:12px; }
    .section-title{ font-size:12px; font-weight:700; text-transform:uppercase; color:#475569; letter-spacing:.5px; margin:10px 0 6px;}
    .card{ background:#ffffff; border:1px solid var(--line); border-radius:14px; padding:10px; box-shadow:0 1px 2px rgba(0,0,0,.04);}
    .small{ font-size:12px; color:#64748b; }

    /* Local Fire Weather chips */
    .chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:13px; font-weight:600; color:#fff; }
    .chip.ok{ background:var(--ok); }
    .chip.warn{ background:var(--warn); }
    .chip.bad{ background:var(--bad); }
    details summary{ cursor:pointer; list-style:none; }
    details summary::-webkit-details-marker{ display:none; }

    /* Bottom sheet (forecast) */
    #sheet{ position:fixed; left:0; right:0; bottom:0; transform:translateY(100%); transition:transform .25s ease; background:#ffffff;
            border-top-left-radius:16px; border-top-right-radius:16px; box-shadow:0 -8px 24px rgba(0,0,0,.2); max-height:70vh; display:flex; flex-direction:column; z-index:6; }
    #sheet.open{ transform:translateY(0); }
    #sheet .handle{ align-self:center; width:44px; height:5px; background:#cbd5e1; border-radius:999px; margin:8px 0; }
    #sheet .head{ padding:0 12px 6px; display:flex; align-items:center; justify-content:space-between; }
    #sheet .body{ overflow:auto; padding:0 12px 12px; }
    .forecast-list{ list-style:none; margin:0; padding:0; display:grid; gap:6px;}
    .forecast-item{ display:flex; align-items:center; justify-content:space-between; border:1px dashed var(--line); padding:8px 10px; border-radius:10px; font-size:13px; }

    /* Floating refresh */
    #fabRefresh{ position:fixed; right:12px; bottom:12px; z-index:6; box-shadow:0 6px 18px rgba(0,0,0,.25); }

    /* Mobile: put ASIDE above the MAP (data first) */
    @media(max-width:900px){
      #app{
        display:grid;
        grid-template-areas:
          'header'
          'toolbar'
          'aside'
          'map';
        grid-template-columns:1fr;
        grid-template-rows:56px auto auto 44vh;
      }
      aside{ border-left:0; border-top:1px solid var(--line); }
    }

    /* Lock the map while sheet open (prevents scroll fight) */
    html.lock-scroll, body.lock-scroll{ overflow:hidden; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="title">üî• Five Forks Fire Weather Dashboard</div>
      <div class="actions">
        <a id="firmsBtn" href="#" class="btn" target="_blank" title="Open FIRMS Map">üåé FIRMS Map</a>
        <a class="btn" href="https://www.weather.gov/akq" target="_blank" title="Open NWS AKQ">üõ∞Ô∏è NWS AKQ</a>
      </div>
    </header>

    <!-- County cards -->
    <section id="toolbar">
      <div id="overview" role="list" aria-label="County overview"></div>
    </section>

    <!-- Map -->
    <div id="map"></div>

    <!-- Data-first side panel -->
    <aside>
      <div class="panel">
        <div class="section-title">üî• Local Fire Weather</div>
        <div id="riskPanel" class="card">
          <div class="small" id="riskStatus">Computing local risk‚Ä¶</div>
          <div style="margin-top:6px; display:grid; gap:6px;">
            <div><strong>30/30/30:</strong> <span id="chip3030" class="chip ok">none</span></div>
            <div><strong>Crossover:</strong> <span id="chipX" class="chip ok">none</span></div>
            <details style="margin-top:4px;">
              <summary class="small">What this means</summary>
              <div class="small" style="margin-top:6px;">
                <strong>30/30/30</strong> flags when within the next few hours all three are true at once:
                Temp ‚â• 80¬∞F, RH ‚â§ 30%, and wind ‚â• 10 mph.<br/>
                <strong>Crossover</strong> flags when dew-point depression (T ‚àí Td) ‚â• <em>18.5 ¬∞C</em> (very dry near-surface air).
              </div>
            </details>
          </div>
        </div>

        <div class="section-title">‚ö†Ô∏è VA Alerts (NWS)</div>
        <div id="alertsPanel" class="card"><div class="small">Loading active alerts‚Ä¶</div></div>

        <div class="section-title">Layers</div>
        <div id="quickLayers" class="card" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
      </div>
    </aside>
  </div>

  <!-- Bottom sheet for point forecast -->
  <section id="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
    <div class="handle"></div>
    <div class="head">
      <div>
        <div id="sheetTitle" style="font-weight:700">Point Forecast</div>
        <div id="sheetSub" class="small"></div>
      </div>
      <button id="sheetClose" class="btn" aria-label="Close forecast">‚úï</button>
    </div>
    <div class="body">
      <ul id="sheetList" class="forecast-list"></ul>
    </div>
  </section>

  <!-- Floating Refresh -->
  <button id="fabRefresh" class="btn" title="Refresh data">üîÑ Refresh</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const byId = (id)=>document.getElementById(id);

    // --- Map init ---
    const COUNTY = [
      { id:'amelia', name:'Amelia',       lat:37.34, lon:-77.98 },
      { id:'nottoway', name:'Nottoway',   lat:37.14, lon:-78.05 },
      { id:'dinwiddie', name:'Dinwiddie', lat:37.08, lon:-77.66 },
      { id:'prgeorge', name:'Prince George', lat:37.20, lon:-77.22 },
      { id:'brunswick', name:'Brunswick', lat:36.77, lon:-77.87 },
      { id:'greensville', name:'Greensville', lat:36.68, lon:-77.56 }
    ];

    // Dynamic bounds that truly cover all counties (+ a little margin)
    const extent = COUNTY.reduce((acc,c)=>({
      minLat: Math.min(acc.minLat, c.lat),
      maxLat: Math.max(acc.maxLat, c.lat),
      minLon: Math.min(acc.minLon, c.lon),
      maxLon: Math.max(acc.maxLon, c.lon)
    }), {minLat:90, maxLat:-90, minLon:180, maxLon:-180});
    const pad = 0.18; // widen so edge pixels are included
    const focusBounds = L.latLngBounds(
      [[extent.minLat-pad, extent.minLon-pad],[extent.maxLat+pad, extent.maxLon+pad]]
    );

    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);
    map.fitBounds(focusBounds);
    L.rectangle(focusBounds, { color:'#0ea5e9', weight:1, fillOpacity:0.03 }).addTo(map);
    requestAnimationFrame(()=>map.invalidateSize());
    addEventListener('resize', ()=>map.invalidateSize());

    // Header FIRMS button (opens FIRMS viewer at current view)
    byId('firmsBtn').addEventListener('click', (e)=>{
      e.preventDefault();
      const c=map.getCenter(), z=map.getZoom();
      const url=`https://firms.modaps.eosdis.nasa.gov/usfs/map/#d:today;l:fires_all,fire-perimeter,countries,earth;@${c.lng.toFixed(2)},${c.lat.toFixed(2)},${z.toFixed(2)}z`;
      window.open(url,'_blank');
    });

    // --- FIRMS quick layer toggles (reliable hotspots overlays) ---
    const MAP_KEY='01e7d5c7c7cd67df54a0e6f08c21e6ab';
    const firmsBase = ()=>`https://firms.modaps.eosdis.nasa.gov/mapserver/wms/fires/${MAP_KEY}/?`;
    const FIRMS = [
      { id:'viirs24', name:'VIIRS 24h', params:{ layers:'fires_viirs_24', format:'image/png', transparent:true, version:'1.1.1' } },
      { id:'modis24', name:'MODIS 24h', params:{ layers:'fires_modis_24', format:'image/png', transparent:true, version:'1.1.1' } },
      { id:'tsd',     name:'Time Since', params:{ layers:'tsd_4_viirs_all', format:'image/png', transparent:true, version:'1.1.1' } },
    ];
    const layers = new Map();
    function addLayer(cfg){ return L.tileLayer.wms(firmsBase(), cfg.params); }
    function buildQuickLayers(){
      const bar = byId('quickLayers'); bar.innerHTML='';
      layers.forEach(lyr=>{ if(map.hasLayer(lyr)) map.removeLayer(lyr);}); layers.clear();
      FIRMS.forEach(cfg=>{
        const btn=document.createElement('button'); btn.className='btn'; btn.style.minHeight='36px'; btn.textContent=cfg.name;
        const lyr=addLayer(cfg); layers.set(cfg.id,lyr);
        btn.onclick=()=>{ if(map.hasLayer(lyr)){ map.removeLayer(lyr); btn.classList.remove('active'); } else { lyr.addTo(map); btn.classList.add('active'); } };
        bar.appendChild(btn);
        if(cfg.id==='viirs24'){ lyr.addTo(map); btn.classList.add('active'); }
      });
    }
    buildQuickLayers();

    // --- NWS Alerts for VA ---
    const alertsPanel = byId('alertsPanel');
    const alertsLayer = L.geoJSON(null, { style:{ color:'#ef4444', weight:2, opacity:0.9, fillOpacity:0.08 } }).addTo(map);
    async function loadVAAlerts(){
      try{
        alertsPanel.innerHTML='<div class="small">Fetching alerts‚Ä¶</div>';
        const r = await fetch('https://api.weather.gov/alerts/active?area=VA', { headers:{'Accept':'application/geo+json'} });
        const j = await r.json();
        alertsLayer.clearLayers(); let count=0;
        (j.features||[]).forEach(f=>{ if(f.geometry){ alertsLayer.addData(f); count++; } });
        alertsPanel.innerHTML = count ? `<div class="small">Active alerts in VA: <strong>${count}</strong></div>` : '<div class="small">No active alerts.</div>';
      }catch{
        alertsPanel.innerHTML='<div class="small">Alerts unavailable.</div>';
      }
    }

    // ===== Forecast cache =====
    const TTL_MS = 15*60*1000;
    const FCACHE_KEY='ffwd_forecast_cache_v1';
    let forecastCache={}; try{ const raw=localStorage.getItem(FCACHE_KEY); if(raw) forecastCache=JSON.parse(raw)||{}; }catch{}
    const cacheKey=(lat,lon)=>`${lat.toFixed(3)},${lon.toFixed(3)}`;
    const saveCache=()=>{ try{ localStorage.setItem(FCACHE_KEY, JSON.stringify(forecastCache)); }catch{} };

    function localTime(iso){ return new Date(iso).toLocaleString([], {hour:'numeric'}); }
    function mphFrom(w){ if(!w) return 0; const m = String(w).match(/(\d+)(?=\s*mph)/i) || String(w).match(/(\d+)/); return m? parseInt(m[1],10):0; }
    const FtoC = f => (f-32)*5/9;

    // Magnus formula for dew point (¬∞C)
    function dewpointC(tempC, rh){
      if(rh==null || rh<=0) return NaN;
      const a=17.625, b=243.04;
      const gamma = (a*tempC)/(b+tempC) + Math.log(rh/100);
      return (b*gamma)/(a-gamma);
    }

    async function getHourly(lat, lon, {force=false}={}){
      const key=cacheKey(lat,lon), now=Date.now();
      if(!force){
        const entry=forecastCache[key];
        if(entry && Array.isArray(entry.periods) && entry.periods.length && (now-entry.ts)<TTL_MS) return entry.periods;
      }
      const p = await fetch(`https://api.weather.gov/points/${lat.toFixed(4)},${lon.toFixed(4)}`);
      const pj=await p.json(); const hourly=pj?.properties?.forecastHourly;
      if(!hourly) throw new Error('No hourly');
      const h=await fetch(hourly); const hj=await h.json();
      const periods=(hj?.properties?.periods||[]);
      forecastCache[key]={ts:Date.now(), periods}; saveCache();
      return periods;
    }

    // --- County cards (no hotspots per county) ---
    const overview = byId('overview');
    const countyData = new Map(); // id -> {periods,temp,rh,wind}
    function updateCard(c){
      const d = countyData.get(c.id); if(!d) return;
      byId(`ov-t-${c.id}`).textContent = d.temp;
      byId(`ov-r-${c.id}`).textContent = d.rh;
      byId(`ov-w-${c.id}`).textContent = d.wind;
    }
    async function loadCounty(c, force=false){
      try{
        const periods=await getHourly(c.lat,c.lon,{force});
        const now=periods[0]||{};
        const data={
          periods,
          temp:(now.temperature!=null? `${now.temperature}¬∞${now.temperatureUnit}` : '‚Äì'),
          rh:(now.relativeHumidity?.value!=null? `${Math.round(now.relativeHumidity.value)}%` : '‚Äì'),
          wind:(now.windSpeed || '‚Äì')
        };
        countyData.set(c.id,data);
      }catch{
        countyData.set(c.id,{periods:[], temp:'‚Äì', rh:'‚Äì', wind:'‚Äì'});
      }
      updateCard(c);
    }
    function buildOverview(){
      overview.innerHTML='';
      COUNTY.forEach(c=>{
        const card=document.createElement('div'); card.className='ov-card'; card.id=`ov-${c.id}`; card.tabIndex=0; card.setAttribute('role','button');
        card.innerHTML=`
          <div class="ov-main">
            <div class="ov-name">${c.name}</div>
            <div class="ov-line"><span id="ov-t-${c.id}">‚Ä¶</span> ¬∑ RH <span id="ov-r-${c.id}">‚Ä¶</span> ¬∑ <span id="ov-w-${c.id}">‚Ä¶</span></div>
          </div>`;
        card.addEventListener('click', ()=>openCountyForecast(c));
        card.addEventListener('keypress', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openCountyForecast(c);} });
        overview.appendChild(card);
      });
    }

    // --- Bottom sheet ---
    const sheet = byId('sheet');
    byId('sheetClose').onclick = ()=> closeSheet();
    function openSheet(){ sheet.classList.add('open'); document.documentElement.classList.add('lock-scroll'); document.body.classList.add('lock-scroll'); map.dragging.disable(); map.scrollWheelZoom.disable(); }
    function closeSheet(){ sheet.classList.remove('open'); document.documentElement.classList.remove('lock-scroll'); document.body.classList.remove('lock-scroll'); map.dragging.enable(); map.scrollWheelZoom.enable(); }
    function renderSheet(periods, title){
      byId('sheetTitle').textContent=title||'Point Forecast';
      byId('sheetSub').textContent='';
      const list=byId('sheetList');
      list.innerHTML=(periods||[]).slice(0,12).map(p=>`<li class="forecast-item"><span>${localTime(p.startTime)}</span><span>${p.temperature}¬∞${p.temperatureUnit}</span><span>RH ${p.relativeHumidity?.value??'‚Äì'}%</span><span>${p.windSpeed}</span></li>`).join('');
      openSheet();
      window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
    }
    async function openCountyForecast(c){
      map.setView([c.lat,c.lon], Math.max(map.getZoom(),10));
      byId('sheetList').innerHTML=`<li class="forecast-item"><span class="small">Loading‚Ä¶</span></li>`;
      openSheet();
      try{
        const d=countyData.get(c.id);
        const periods=(d && d.periods && d.periods.length)? d.periods : await getHourly(c.lat,c.lon);
        if(!d) countyData.set(c.id,{periods}); else d.periods=periods;
        renderSheet(periods, c.name);
      }catch{
        byId('sheetList').innerHTML=`<li class="forecast-item"><span class="small">Forecast unavailable</span></li>`;
      }
    }
    map.on('click', async (e)=>{
      byId('sheetTitle').textContent='Map Point';
      byId('sheetSub').textContent='';
      byId('sheetList').innerHTML=`<li class="forecast-item"><span class="small">Loading‚Ä¶</span></li>`;
      openSheet();
      try{ const periods=await getHourly(e.latlng.lat, e.latlng.lng); renderSheet(periods,'Map Point'); }
      catch{ byId('sheetList').innerHTML=`<li class="forecast-item"><span class="small">Forecast unavailable</span></li>`; }
    });

    // --- Local Fire Weather (30/30/30 + Crossover 18.5 ¬∞C) ---
    function evaluateRisk(periods){
      const next = (periods||[]).slice(0,6); // next ~6 hours
      let hit3030=false, hitX=false;
      for(const p of next){
        const tF=p.temperature, tU=p.temperatureUnit||'F';
        const tC = tU.toUpperCase()==='C' ? tF : FtoC(tF);
        const rh = p?.relativeHumidity?.value ?? null;
        const wind = mphFrom(p.windSpeed);

        if(tF>=80 && rh!=null && rh<=30 && wind>=10) hit3030=true;

        if(rh!=null){
          const tdC = dewpointC(tC, rh);
          const dpd = tC - tdC; // ¬∞C
          if(dpd >= 18.5) hitX=true;
        }
      }
      return { hit3030, hitX };
    }
    function paintRisk({hit3030, hitX}){
      const c3030 = byId('chip3030'), cx = byId('chipX');
      c3030.textContent = hit3030 ? 'met (next hrs)' : 'none';
      cx.textContent = hitX ? 'met (next hrs)' : 'none';
      c3030.className = 'chip ' + (hit3030?'bad':'ok');
      cx.className = 'chip ' + (hitX?'warn':'ok');
      byId('riskStatus').textContent = 'Computed from the next few hours at map center.';
    }
    async function computeLocalRisk(){
      try{
        const c = map.getCenter();
        const periods = await getHourly(c.lat, c.lng);
        paintRisk(evaluateRisk(periods));
      }catch{
        byId('riskStatus').textContent='Risk unavailable.';
      }
    }

    // --- Boot ---
    buildOverview();
    COUNTY.forEach(c=>loadCounty(c));
    loadVAAlerts();
    computeLocalRisk();

    // Refresh (force fresh pulls)
    byId('fabRefresh').onclick = ()=>{
      loadVAAlerts();
      COUNTY.forEach(c=>loadCounty(c,true));
      computeLocalRisk();
      const z=map.getZoom(); map.setZoom(z); // nudge tiles
    };
  </script>
</body>
</html>
