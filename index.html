<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ðŸ”¥ Five Forks Fire Weather</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
  <!-- Turf (for simple proximity checks) -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js" defer></script>

  <style>
    :root { --bg:#0f172a; --text:#e5e7eb; --card:#111827; --border:#334155; --brand:#3b82f6; --muted:#9ca3af; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{background:var(--brand);color:#fff;padding:.75rem 1rem;display:flex;justify-content:space-between;align-items:center;gap:.5rem;flex-wrap:wrap}
    h1{margin:0;font-size:1.05rem}
    .menu{display:flex;gap:.5rem;flex-wrap:wrap}
    .btn,.menu a{background:#fff;color:#111;border:1px solid #e5e7eb;padding:.35rem .6rem;border-radius:9999px;text-decoration:none;font-size:.85rem}
    main{display:grid;gap:1rem;padding:1rem}
    .cards{display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:.9rem;box-shadow:0 1px 4px rgba(0,0,0,.25)}
    .meta{font-size:.8rem;color:var(--muted);text-align:right}
    .map-wrap{height:520px;border-radius:14px;overflow:hidden;border:1px solid var(--border)}
    footer{color:var(--muted);text-align:center;padding:1rem}
    .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .5rem;border-radius:9999px;border:1px solid var(--border);background:#fff;color:#111;font-size:.75rem}
    .ok{color:#10b981;border-color:#10b981}.warn{color:#f59e0b;border-color:#f59e0b}.err{color:#ef4444;border-color:#ef4444}
  </style>
</head>
<body>
  <header>
    <h1>ðŸ”¥ Five Forks Fire Weather</h1>
    <nav class="menu" aria-label="Primary">
      <button id="unitBtn" class="btn" title="Toggle Â°F/Â°C">Â°F</button>
      <button id="refreshBtn" class="btn" title="Refresh">ðŸ”„ Refresh</button>
      <span id="statusPill" class="pill">â€”</span>
      <a href="https://www.weather.gov/akq/" target="_blank" rel="noopener">AKQ</a>
      <a href="https://www.weather.gov/dlh/fwd#" target="_blank" rel="noopener">FWD</a>
      <a href="https://fs-prod-nwcg.s3.us-gov-west-1.amazonaws.com/s3fs-public/publication/pms461.pdf" target="_blank" rel="noopener">IRPG</a>
    </nav>
  </header>

  <main>
    <div id="updated" class="meta">Last updated: â€”</div>
    <section id="cards" class="cards" aria-live="polite" aria-busy="false"></section>
    <section class="map-wrap" aria-label="Active wildfire hotspots map"><div id="map" style="height:100%"></div></section>
  </main>

  <footer>Data: NOAA & NASA FIRMS â€¢ Updates hourly</footer>

  <script>
    // ---- Config ----
    const COUNTIES = [
      { name: "Amelia",        lat: 37.342, lon: -77.980 },
      { name: "Nottoway",      lat: 37.142, lon: -78.089 },
      { name: "Dinwiddie",     lat: 37.077, lon: -77.587 },
      { name: "Prince George", lat: 37.221, lon: -77.288 },
      { name: "Brunswick",     lat: 36.758, lon: -77.847 },
      { name: "Greensville",   lat: 36.686, lon: -77.542 }
    ];
    const FIRMS_URL = "https://firms.modaps.eosdis.nasa.gov/active_fire/c6.1/geojson/MODIS_C6_1_USA_contiguous_and_Hawaii_24h.geojson";
    const BUFFER_KM = 20;

    // ---- State ----
    let unit = (localStorage.getItem('ff:unit') || 'F');
    let lastSuccessAt = 0;

    // ---- Helpers ----
    const $ = sel => document.querySelector(sel);
    function fmtStamp(d=new Date()){ return d.toLocaleString(undefined,{hour12:true}); }
    const toC = f => Math.round(((f-32)*5)/9);
    function setStatus(text, cls){ const pill = $('#statusPill'); pill.className='pill ' + (cls||''); pill.textContent=text; }

    async function fetchJSON(url, options={}){
      const res = await fetch(url, options);
      if(!res.ok) throw new Error('HTTP '+res.status+' for '+url);
      return res.json();
    }

    async function fetchWeather(lat, lon){
      try{
        const meta = await fetchJSON(`https://api.weather.gov/points/${lat},${lon}`, { headers:{'Accept':'application/geo+json'} });
        const hourlyUrl = meta?.properties?.forecastHourly;
        if(!hourlyUrl) throw new Error('No hourly URL');
        const data = await fetchJSON(hourlyUrl, { headers:{'Accept':'application/geo+json'} });
        const p = data?.properties?.periods?.[0];
        if(!p) return null;
        return {
          tempF: Number.isFinite(p.temperature)? p.temperature: null,
          rh: Math.round(p?.relativeHumidity?.value ?? NaN),
          wind: [p.windSpeed||'', p.windDirection||''].filter(Boolean).join(' '),
          short: p.shortForecast || 'â€”'
        };
      }catch(e){
        console.warn('NOAA fetch error', e);
        return null;
      }
    }

    function renderCard(name, wx, hotspots){
      const el = document.createElement('div');
      el.className = 'card';
      const t = (wx&&Number.isFinite(wx.tempF)) ? (unit==='C'? toC(wx.tempF)+'Â°C' : Math.round(wx.tempF)+'Â°F') : 'â€”';
      const hsHtml = Number.isFinite(hotspots) ? ` Â· ðŸ”¥ ${hotspots}` : '';
      el.innerHTML = wx
        ? `<strong>${name}</strong><br>${t} Â· ${Number.isFinite(wx.rh)? wx.rh:'â€”'}% RH Â· ${wx.wind}<br>${wx.short}${hsHtml}`
        : `<strong>${name}</strong><br>Weather unavailable${hsHtml}`;
      return el;
    }

    function countHotspotsNear(geojson, lat, lon, km=BUFFER_KM){
      if(!geojson?.features?.length) return 0;
      const center = turf.point([lon, lat]);
      const circle = turf.circle([lon, lat], km, { units:'kilometers' });
      let n = 0;
      for(const f of geojson.features){
        try{
          if(!f.geometry || f.geometry.type!=='Point') continue;
          const [x,y] = f.geometry.coordinates;
          if(turf.booleanPointInPolygon(turf.point([x,y]), circle)) n++;
        }catch{}
      }
      return n;
    }

    async function refresh(){
      setStatus('Loadingâ€¦');
      $('#cards').setAttribute('aria-busy','true');
      $('#updated').textContent = 'Last updated: ' + fmtStamp();

      const [firms, wxResults] = await Promise.all([
        fetchJSON(FIRMS_URL).catch(()=>({type:'FeatureCollection',features:[]})),
        Promise.all(COUNTIES.map(c => fetchWeather(c.lat, c.lon)))
      ]);

      const frag = document.createDocumentFragment();
      COUNTIES.forEach((c, i) => {
        const hs = countHotspotsNear(firms, c.lat, c.lon, BUFFER_KM);
        frag.appendChild(renderCard(c.name, wxResults[i], hs));
      });
      $('#cards').replaceChildren(frag);

      lastSuccessAt = Date.now();
      setStatus('Fresh', 'ok');
      $('#cards').setAttribute('aria-busy','false');

      // Map
      ensureMap(firms);
    }

    // ---- Map ----
    let map, firmsLayer, centersLayer, buffersLayer;
    function ensureMap(firms){
      if(!map){
        map = L.map('map').setView([37.1, -77.5], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution:'Â© OpenStreetMap contributors'
        }).addTo(map);
        firmsLayer = L.layerGroup().addTo(map);
        centersLayer = L.layerGroup().addTo(map);
        buffersLayer = L.layerGroup().addTo(map);
        L.control.layers({}, {
          'ðŸ”¥ Hotspots': firmsLayer,
          'ðŸŸ¢ Buffers (20 km)': buffersLayer,
          'ðŸ“ County centers': centersLayer
        }, { collapsed:true }).addTo(map);
      }
      firmsLayer.clearLayers(); centersLayer.clearLayers(); buffersLayer.clearLayers();

      // Draw FIRMS
      L.geoJSON(firms, {
        pointToLayer: (f,latlng) => L.circleMarker(latlng,{
          radius:5, fillColor:'#ff3b30', color:'#ff3b30', weight:1, opacity:1, fillOpacity:0.8
        }).bindPopup('ðŸ”¥ Fire detected'))
      }).addTo(firmsLayer);

      // Centers + buffers
      COUNTIES.forEach(c=>{
        const m = L.marker([c.lat, c.lon]).bindPopup(`<strong>${c.name}</strong>`);
        m.addTo(centersLayer);
        const circle = L.circle([c.lat,c.lon], { radius: BUFFER_KM*1000, color:'#22c55e', fill:false });
        circle.addTo(buffersLayer);
      });
    }

    // ---- UI ----
    $('#unitBtn').textContent = 'Â°'+unit;
    $('#unitBtn').addEventListener('click', ()=>{
      unit = (unit==='F'?'C':'F');
      localStorage.setItem('ff:unit', unit);
      $('#unitBtn').textContent = 'Â°'+unit;
      refresh();
    });
    $('#refreshBtn').addEventListener('click', refresh);

    // Initial load
    refresh();
    // Auto-refresh hourly
    setInterval(refresh, 60*60*1000);
  </script>
</body>
</html>
