<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Five Forks Fire Dashboard</title>

  <!-- Leaflet (CDN) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

  <style>
    :root{--bg:#0b1220;--text:#e5e7eb;--card:#0f172a;--border:#23304a;--brand:#2563eb;--muted:#9ca3af}
    [data-theme='light']{--bg:#f8fafc;--text:#0f172a;--card:#fff;--border:#e2e8f0;--brand:#2563eb;--muted:#64748b}
    *{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:.5rem;padding:.75rem 1rem;background:#1e53c7;color:#fff}
    h1{margin:0;font-size:1rem}
    .btn{appearance:none;border:1px solid var(--border);border-radius:9999px;padding:.35rem .6rem;background:#fff;color:#0f172a;cursor:pointer}
    main{max-width:820px;margin:0 auto;padding:1rem;display:grid;gap:1rem}
    .grid{display:grid;gap:.75rem;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:.9rem}
    .card h3{margin:.1rem 0 .6rem}.muted{color:var(--muted)}
    .map{height:420px;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .links{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.5rem}
    .link{display:block;text-align:center;padding:.7rem .8rem;border:1px solid var(--border);border-radius:12px;color:var(--text);text-decoration:none;background:rgba(255,255,255,.04)}
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:.6rem">
      <div style="height:32px;width:32px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:#fff;color:var(--brand);font-weight:700;">ðŸ”¥</div>
      <div>
        <div style="font-size:.65rem;opacity:.85;letter-spacing:.06em">Five Forks</div>
        <h1>Fire Dashboard</h1>
      </div>
    </div>
    <div style="display:flex;gap:.5rem;align-items:center">
      <button id="themeBtn" class="btn" title="Toggle theme">ðŸŒ“ Theme</button>
      <button id="refreshBtn" class="btn" title="Refresh">ðŸ”„ Refresh</button>
      <a id="airnowBtn" class="btn" href="https://fire.airnow.gov/#9/37.131/-77.585" target="_blank" rel="noopener">AirNow</a>
    </div>
  </header>

  <main>
    <section class="card">
      <h3>Counties â€” 24h FIRMS hotspots (within 25 km)</h3>
      <div id="when" class="muted">Loadingâ€¦</div>
      <div id="list" class="grid"></div>
    </section>

    <section class="card">
      <h3>Map â€” NASA FIRMS (click a point â†’ opens FIRMS)</h3>
      <div id="map" class="map"></div>
    </section>

    <section class="card">
      <h3>Quick Links</h3>
      <div class="links">
        <a class="link" href="https://www.weather.gov/akq/" target="_blank" rel="noopener">NWS AKQ</a>
        <a class="link" href="https://www.weather.gov/dlh/fwd#" target="_blank" rel="noopener">FWD</a>
        <a class="link" href="https://fs-prod-nwcg.s3.us-gov-west-1.amazonaws.com/s3fs-public/publication/pms461.pdf" target="_blank" rel="noopener">IRPG (PDF)</a>
        <a class="link" href="https://firms.modaps.eosdis.nasa.gov/map/#@-77.585,37.131,10z" target="_blank" rel="noopener">NASA FIRMS Viewer</a>
        <a class="link" href="https://fire.airnow.gov/#9/37.131/-77.585" target="_blank" rel="noopener">AirNow Fire Map</a>
        <a class="link" href="https://spot.nws.noaa.gov/" target="_blank" rel="noopener">NWS Spot Forecast</a>
      </div>
    </section>

    <footer class="muted" style="text-align:center">Single-file build for GitHub Pages. No extra files needed.</footer>
  </main>

<script>
  // --- Config (edit safely if needed) ---
  const COUNTIES=[
    { name:"Amelia", lat:37.342, lon:-77.980 },
    { name:"Nottoway", lat:37.142, lon:-78.089 },
    { name:"Dinwiddie", lat:37.077, lon:-77.587 },
    { name:"Prince George", lat:37.221, lon:-77.288 },
    { name:"Brunswick", lat:36.758, lon:-77.847 },
    { name:"Greensville", lat:36.686, lon:-77.542 }
  ];
  const HOTSPOT_RADIUS_KM=25;
  const FIRMS_URL="https://firms.modaps.eosdis.nasa.gov/active_fire/c6.1/geojson/MODIS_C6_1_USA_contiguous_and_Hawaii_24h.geojson";
  const BBOX=[-78.5,36.4,-77.0,37.7]; // minLon,minLat,maxLon,maxLat
  const TILES={
    light:{ url:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', attr:'Â© OpenStreetMap contributors' },
    dark:{  url:'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', attr:'Â© OpenStreetMap contributors, Â© CARTO' }
  };

  // --- Helpers ---
  const $=s=>document.querySelector(s);
  const fmt=()=>new Date().toLocaleString();
  const withTimeout=(ms=12000)=>{ const c=new AbortController(),t=setTimeout(()=>c.abort(),ms);
    const ex=(i,o={})=>fetch(i,{...o,signal:c.signal}).finally(()=>clearTimeout(t)); return {ex}; };
  async function getJSON(url, ms=12000){ const ft=withTimeout(ms); const r=await ft.ex(url); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
  const hav=(a,b,c,d)=>{ const R=6371,toR=x=>x*Math.PI/180, dLat=toR(c-a), dLon=toR(d-b);
    const A=Math.sin(dLat/2)**2+Math.cos(toR(a))*Math.cos(toR(c))*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(A)); };

  // --- FIRMS ---
  async function fetchFirms(){
    try{
      const geo=await getJSON(FIRMS_URL);
      const pts=[];
      for(const f of geo.features||[]){
        if(!f||!f.geometry||f.geometry.type!=='Point') continue;
        const [lon,lat]=f.geometry.coordinates||[];
        if(lon>=BBOX[0]&&lon<=BBOX[2]&&lat>=BBOX[1]&&lat<=BBOX[3]) pts.push({lat,lon});
      }
      return pts;
    }catch(e){ console.warn('FIRMS error',e); return []; }
  }

  // --- UI ---
  function renderList(points){
    const host=$("#list"); host.innerHTML='';
    for(const c of COUNTIES){
      let n=0; for(const p of points){ if(hav(c.lat,c.lon,p.lat,p.lon)<=HOTSPOT_RADIUS_KM) n++; }
      const card=document.createElement('div');
      card.className='card';
      card.innerHTML=`<h3>${c.name}</h3><div class="muted">ðŸ”¥ ${n} hotspots within ${HOTSPOT_RADIUS_KM} km</div>`;
      host.appendChild(card);
    }
  }

  let map, light, dark, firmsLayer;
  function initMap(){
    map=L.map('map').setView([37.131,-77.585],8);
    light=L.tileLayer(TILES.light.url,{attribution:TILES.light.attr});
    dark =L.tileLayer(TILES.dark.url, {attribution:TILES.dark.attr});
    (document.documentElement.dataset.theme==='light'?light:dark).addTo(map);

    // Why: clicking anywhere should deep-link to FIRMS at that spot.
    map.on('click',e=>{
      const z=Math.max(3,Math.min(13,Math.round(map.getZoom())));
      const url=`https://firms.modaps.eosdis.nasa.gov/map/#@${e.latlng.lng.toFixed(3)},${e.latlng.lat.toFixed(3)},${z}z`;
      window.open(url,'_blank','noopener');
    });
  }
  function setMapTheme(){ if(!map) return; const isLight=document.documentElement.dataset.theme==='light';
    if(isLight){ if(map.hasLayer(dark)) map.removeLayer(dark); if(!map.hasLayer(light)) light.addTo(map); }
    else       { if(map.hasLayer(light)) map.removeLayer(light); if(!map.hasLayer(dark)) dark.addTo(map); } }

  function renderPoints(points){
    if(firmsLayer){ firmsLayer.remove(); firmsLayer=null; }
    const fc={ type:'FeatureCollection', features: points.map(p=>({ type:'Feature', geometry:{ type:'Point', coordinates:[p.lon,p.lat] } })) };
    firmsLayer=L.geoJSON(fc,{ pointToLayer:(_,latlng)=> L.circleMarker(latlng,{radius:5,color:'#ef4444',fillColor:'#ef4444',fillOpacity:.85}) }).addTo(map);
  }

  async function run(){
    $("#when").textContent='Updatingâ€¦';
    const pts=await fetchFirms();
    $("#when").textContent='Last updated: '+fmt();
    renderList(pts);
    renderPoints(pts);
  }

  function toggleTheme(){ const lightOn=document.documentElement.dataset.theme==='light';
    document.documentElement.dataset.theme=lightOn?'':'light'; setMapTheme(); }

  window.addEventListener('DOMContentLoaded',()=>{
    document.documentElement.dataset.theme='light'; // light default
    $("#themeBtn").addEventListener('click',toggleTheme);
    $("#refreshBtn").addEventListener('click',run);
    initMap(); run();
  });
</script>
</body>
</html>
