<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Five Forks Fire Weather Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{ --bg:#0f172a;--fg:#e2e8f0;--line:#e5e7eb; --touch:44px; }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    html{scroll-behavior:smooth}
    #app{display:grid;grid-template-areas:'header header' 'toolbar toolbar' 'map aside';
         grid-template-columns:1fr 420px;grid-template-rows:56px auto 1fr;height:100%}
    header{grid-area:header;display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#0f172a;color:#e2e8f0}
    .btn{border:0;border-radius:12px;padding:10px 12px;background:#1f2937;color:#e5e7eb;cursor:pointer;font-size:13px;text-decoration:none;display:inline-flex;align-items:center;gap:6px;min-height:var(--touch)}
    #toolbar{grid-area:toolbar;border-bottom:1px solid var(--line);background:#0a0f1d;padding:10px 12px}
    #overview{display:grid;gap:10px;grid-template-columns:repeat(2,1fr)}
    @media(min-width:900px){#overview{grid-template-columns:repeat(3,1fr)}}
    .ov-card{background:#0f182c;border:1px solid #22314a;border-radius:14px;padding:12px;color:#d7e3f7;display:flex;justify-content:space-between;align-items:center;gap:10px;min-height:76px;cursor:pointer}
    .ov-main{display:grid;gap:4px}.ov-name{font-weight:700}.ov-line{font-size:13px;color:#b9c9e3}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #22314a;background:#0b1529;color:#dfe9fb;padding:6px 10px;border-radius:999px;font-size:12px}
    #map{grid-area:map;height:100%;width:100%}
    aside{grid-area:aside;border-left:1px solid var(--line);overflow:auto}
    .panel{padding:12px}
    .section-title{font-size:12px;font-weight:700;text-transform:uppercase;color:#475569;margin:10px 0 6px}
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px}
    .small{font-size:12px;color:#64748b}
    #sheet{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);transition:.25s ease transform;background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;box-shadow:0 -8px 24px rgba(0,0,0,.2);max-height:70vh;display:flex;flex-direction:column;z-index:6}
    #sheet.open{transform:translateY(0)} #sheet .handle{align-self:center;width:44px;height:5px;background:#cbd5e1;border-radius:999px;margin:8px 0}
    #sheet .head{padding:0 12px 6px;display:flex;align-items:center;justify-content:space-between}
    #sheet .body{overflow:auto;padding:0 12px 12px}
    .forecast-list{list-style:none;margin:0;padding:0;display:grid;gap:6px}
    .forecast-item{display:flex;justify-content:space-between;align-items:center;border:1px dashed #e5e7eb;padding:6px 8px;border-radius:10px;font-size:13px}
    @media(max-width:900px){
      #app{grid-template-areas:'header' 'toolbar' 'map' 'aside';grid-template-columns:1fr;grid-template-rows:56px auto 44vh auto}
      aside{border-left:0;border-top:1px solid var(--line)}
      .panel{padding:12px}
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="title">üî• Five Forks Fire Weather Dashboard</div>
      <div class="actions">
        <a id="firmsBtn" href="#" class="btn" target="_blank" title="Open FIRMS Map">üåé FIRMS Map</a>
        <a href="https://www.weather.gov/akq" class="btn" target="_blank" title="Open NWS AKQ">üõ∞Ô∏è NWS AKQ</a>
      </div>
    </header>

    <section id="toolbar">
      <div id="overview" role="list" aria-label="County overview"></div>
    </section>

    <div id="map"></div>

    <aside>
      <div class="panel">
        <div class="section-title">üî• Local Fire Weather</div>
        <div id="localPanel" class="card"><div class="small">Computing local risk‚Ä¶</div></div>

        <div class="section-title">‚ö†Ô∏è State/Official Alerts (NWS)</div>
        <div id="alertsPanel" class="card"><div class="small">Loading active alerts‚Ä¶</div></div>

        <div class="section-title">Layers</div>
        <div id="quickLayers" class="card" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
      </div>
    </aside>
  </div>

  <!-- Bottom sheet -->
  <section id="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
    <div class="handle"></div>
    <div class="head">
      <div>
        <div id="sheetTitle" style="font-weight:700">Point Forecast</div>
        <div id="sheetSub" class="small"></div>
      </div>
      <button id="sheetClose" class="btn" aria-label="Close forecast">‚úï</button>
    </div>
    <div class="body"><ul id="sheetList" class="forecast-list"></ul></div>
  </section>

  <!-- Floating Refresh -->
  <button id="fabRefresh" class="btn" title="Refresh data" style="position:fixed;right:12px;bottom:12px;z-index:6;box-shadow:0 6px 18px rgba(0,0,0,.25)">üîÑ Refresh</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- Map init ---
    const CENTER = [36.95, -77.50];
    const map = L.map('map').setView(CENTER, 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

    // FIRMS viewer button
    document.getElementById('firmsBtn').addEventListener('click', (e)=>{
      e.preventDefault();
      const c = map.getCenter(); const z = map.getZoom();
      const url = `https://firms.modaps.eosdis.nasa.gov/usfs/map/#d:today;l:fires_all,fire-perimeter,countries,earth;@${c.lng.toFixed(2)},${c.lat.toFixed(2)},${z.toFixed(2)}z`;
      window.open(url, '_blank');
    });

    // --- County cards ---
    const COUNTY = [
      { id:'amelia', name:'Amelia',       lat:37.34, lon:-77.98 },
      { id:'nottoway', name:'Nottoway',   lat:37.14, lon:-78.05 },
      { id:'dinwiddie', name:'Dinwiddie', lat:37.08, lon:-77.66 },
      { id:'prgeorge', name:'Prince George', lat:37.20, lon:-77.22 },
      { id:'brunswick', name:'Brunswick', lat:36.77, lon:-77.87 },
      { id:'greensville', name:'Greensville', lat:36.68, lon:-77.56 }
    ];
    const overview = document.getElementById('overview');
    const sheet = document.getElementById('sheet');
    document.getElementById('sheetClose').onclick = ()=> sheet.classList.remove('open');
    function byId(id){ return document.getElementById(id); }

    function buildOverview(){
      overview.innerHTML='';
      COUNTY.forEach(c=>{
        const card = document.createElement('div'); card.className='ov-card'; card.id=`ov-${c.id}`; card.setAttribute('role','button'); card.setAttribute('tabindex','0');
        card.innerHTML = `
          <div class="ov-main">
            <div class="ov-name">${c.name}</div>
            <div class="ov-line"><span id="ov-t-${c.id}">‚Ä¶</span> ¬∑ RH <span id="ov-r-${c.id}">‚Ä¶</span> ¬∑ <span id="ov-w-${c.id}">‚Ä¶</span></div>
          </div>
          <div class="ov-badges"><span class="badge">üî• <span id="ov-hot-${c.id}">‚Ä¶</span></span></div>`;
        card.addEventListener('click', ()=> openCountyForecast(c));
        card.addEventListener('keypress', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openCountyForecast(c); } });
        overview.appendChild(card);
      });
    }

    // --- Cache + forecast fetch ---
    const TTL_MS = 15 * 60 * 1000;
    const FCACHE_KEY = 'ffwd_forecast_cache_v1';
    let forecastCache = {};
    try{ const raw = localStorage.getItem(FCACHE_KEY); if(raw) forecastCache = JSON.parse(raw)||{} }catch{}
    const cacheKey = (lat,lon)=> `${lat.toFixed(3)},${lon.toFixed(3)}`;
    const saveCache = ()=> { try{ localStorage.setItem(FCACHE_KEY, JSON.stringify(forecastCache)); }catch{} };

    async function getHourly(lat, lon, {force=false}={}){
      const key = cacheKey(lat, lon), now=Date.now();
      if(!force){
        const entry = forecastCache[key];
        if(entry && entry.periods?.length && (now - entry.ts) < TTL_MS){ return entry.periods; }
      }
      const p  = await fetch(`https://api.weather.gov/points/${lat.toFixed(4)},${lon.toFixed(4)}`);
      const pj = await p.json(); const hourly = pj?.properties?.forecastHourly;
      if(!hourly) throw new Error('No hourly');
      const h  = await fetch(hourly); const hj = await h.json();
      const periods = hj?.properties?.periods || [];
      forecastCache[key] = { ts: Date.now(), periods }; saveCache(); return periods;
    }

    function renderSheet(periods, title){
      byId('sheetTitle').textContent = title || 'Point Forecast';
      byId('sheetSub').textContent = '';
      const list = byId('sheetList');
      list.innerHTML = (periods||[]).slice(0,12).map(p=>
        `<li class="forecast-item"><span>${new Date(p.startTime).toLocaleString([], {hour:'numeric'})}</span><span>${p.temperature}¬∞${p.temperatureUnit}</span><span>RH ${p.relativeHumidity?.value??'‚Äì'}%</span><span>${p.windSpeed}</span></li>`
      ).join('');
      sheet.classList.add('open');
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    async function openCountyForecast(c){
      map.setView([c.lat, c.lon], 10);
      byId('sheetTitle').textContent = c.name;
      byId('sheetList').innerHTML = `<li class="forecast-item"><span class="small">Loading‚Ä¶</span></li>`;
      sheet.classList.add('open');
      try{
        const d = countyData.get(c.id);
        const periods = (d && d.periods?.length) ? d.periods : await getHourly(c.lat,c.lon);
        if(!d) countyData.set(c.id,{periods}); else d.periods = periods;
        renderSheet(periods, c.name);
      }catch{
        byId('sheetList').innerHTML = `<li class="forecast-item"><span class="small">Forecast unavailable</span></li>`;
      }
    }

    map.on('click', async (e)=>{
      byId('sheetTitle').textContent='Map Point';
      byId('sheetList').innerHTML=`<li class="forecast-item"><span class="small">Loading‚Ä¶</span></li>`;
      sheet.classList.add('open');
      try{ const periods = await getHourly(e.latlng.lat, e.latlng.lng); renderSheet(periods,'Map Point'); }
      catch{ byId('sheetList').innerHTML=`<li class="forecast-item"><span class="small">Forecast unavailable</span></li>`; }
    });

    // --- FIRMS quick layers + hotspots ---
    const MAP_KEY='01e7d5c7c7cd67df54a0e6f08c21e6ab';
    const firmsBase = ()=> `https://firms.modaps.eosdis.nasa.gov/mapserver/wms/fires/${MAP_KEY}/?`;
    const FIRMS = [
      { id:'viirs24', name:'VIIRS 24h', params:{layers:'fires_viirs_24', format:'image/png', transparent:true, version:'1.1.1'}},
      { id:'modis24', name:'MODIS 24h', params:{layers:'fires_modis_24', format:'image/png', transparent:true, version:'1.1.1'}},
      { id:'tsd',    name:'Time Since', params:{layers:'tsd_4_viirs_all', format:'image/png', transparent:true, version:'1.1.1'}},
    ];
    const layers = new Map();
    function addLayer(cfg){ return L.tileLayer.wms(firmsBase(), cfg.params); }
    (function buildQuickLayers(){
      const bar = byId('quickLayers'); bar.innerHTML='';
      FIRMS.forEach(cfg=>{
        const b = document.createElement('button'); b.className='btn'; b.style.minHeight='36px'; b.textContent=cfg.name;
        const lyr = addLayer(cfg); layers.set(cfg.id, lyr);
        b.onclick = ()=>{ if(map.hasLayer(lyr)){ map.removeLayer(lyr); b.classList.remove('active'); } else { lyr.addTo(map); b.classList.add('active'); } };
        bar.appendChild(b);
        if(cfg.id==='viirs24'){ lyr.addTo(map); b.classList.add('active'); }
      });
    })();

    async function countHot(lat, lon){
      const d=0.25; const bbox = `${(lon-d).toFixed(3)},${(lat-d).toFixed(3)},${(lon+d).toFixed(3)},${(lat+d).toFixed(3)}`;
      const url = `https://firms.modaps.eosdis.nasa.gov/api/area/csv/${MAP_KEY}/VIIRS_SNPP_NRT,VIIRS_NOAA20_NRT/1/${bbox}`;
      try{ const r = await fetch(url); if(!r.ok) throw 0; const t = await r.text(); const Ls = t.trim().split(/\r?\n/); return (Ls.length>1)?(Ls.length-1):0; }
      catch{ return null; }
    }

    // --- County data wire-up ---
    const countyData = new Map();
    function updateCard(c){
      const d = countyData.get(c.id); if(!d) return;
      byId(`ov-t-${c.id}`).textContent = d.temp;
      byId(`ov-r-${c.id}`).textContent = d.rh;
      byId(`ov-w-${c.id}`).textContent = d.wind;
      byId(`ov-hot-${c.id}`).textContent = (d.hotspots==null ? 'n/a' : d.hotspots);
      renderLocal();
    }

    async function loadCounty(c, force=false){
      try{
        const [periods, hotspots] = await Promise.all([ getHourly(c.lat,c.lon,{force}), countHot(c.lat,c.lon) ]);
        const now = periods[0] || {};
        countyData.set(c.id, {
          periods,
          temp: (now.temperature!=null? `${now.temperature}¬∞${now.temperatureUnit}` : '‚Äì'),
          rh: (now.relativeHumidity?.value!=null? `${Math.round(now.relativeHumidity.value)}%` : '‚Äì'),
          wind: (now.windSpeed || '‚Äì'),
          hotspots
        });
      }catch{
        countyData.set(c.id, { periods:[], temp:'‚Äì', rh:'‚Äì', wind:'‚Äì', hotspots:null });
      }
      updateCard(c);
    }

    // --- Local Fire Weather (30/30/30 + Crossover) ---
    function parseNum(str){ const m=(str||'').match(/-?\d+/); return m? parseInt(m[0],10): null; }
    function parsePct(str){ const m=(str||'').match(/\d+/); return m? parseInt(m[0],10): null; }
    function parseWindMph(str){
      if(!str) return null;
      const vals = (str.split(/[^0-9.]+/).filter(Boolean)||[]).map(v=>parseFloat(v)).filter(v=>!Number.isNaN(v));
      return vals.length ? Math.max(...vals) : null;
    }
    const THIRTY = { tempF:86, rhPct:30, windMph:18 };
    const localPanel = byId('localPanel');

    function computeThirty(){
      const hit=[];
      COUNTY.forEach(c=>{
        const d=countyData.get(c.id); if(!d) return;
        const t=parseNum(d.temp), r=parsePct(d.rh), w=parseWindMph(d.wind);
        if(t!=null && r!=null && w!=null && t>=THIRTY.tempF && r<=THIRTY.rhPct && w>=THIRTY.windMph){ hit.push(c.name); }
      }); return hit;
    }
    function computeCrossover(){
      const hit=[];
      COUNTY.forEach(c=>{
        const d=countyData.get(c.id); if(!d) return;
        const t=parseNum(d.temp), r=parsePct(d.rh);
        if(t!=null && r!=null && t>=r){ hit.push(c.name); }
      }); return hit;
    }
    function renderLocal(){
      if(!localPanel) return;
      const t=computeThirty(), x=computeCrossover();
      const a = t.length ? `<div class="small"><strong>30/30/30:</strong> ${t.join(', ')}</div>` : `<div class="small">30/30/30: none currently.</div>`;
      const b = x.length ? `<div class="small"><strong>Crossover:</strong> ${x.join(', ')}</div>` : `<div class="small">Crossover: none currently.</div>`;
      localPanel.innerHTML = a + b;
    }

    // --- State/Official Alerts (NWS) ---
    const alertsPanel = byId('alertsPanel');
    const alertsLayer = L.geoJSON(null, { style:{ color:'#ef4444', weight:2, opacity:0.9, fillOpacity:0.08 } }).addTo(map);
    async function loadVAAlerts(){
      try{
        alertsPanel.innerHTML='<div class="small">Fetching alerts‚Ä¶</div>';
        const r = await fetch('https://api.weather.gov/alerts/active?area=VA');
        const j = await r.json();
        alertsLayer.clearLayers(); let count=0;
        (j.features||[]).forEach(f=>{ if(f.geometry){ alertsLayer.addData(f); count++; } });
        alertsPanel.innerHTML = count ? `<div class="small">Active alerts in VA: <strong>${count}</strong></div>`
                                      : '<div class="small">No active alerts.</div>';
      }catch{ alertsPanel.innerHTML='<div class="small">Alerts unavailable.</div>'; }
    }

    // Boot
    buildOverview();
    COUNTY.forEach(c=> loadCounty(c));
    loadVAAlerts();

    // Refresh
    function refreshAll(){ loadVAAlerts(); COUNTY.forEach(c=> loadCounty(c, true)); const z=map.getZoom(); map.setZoom(z); }
    document.getElementById('fabRefresh').onclick = refreshAll;

    // Focus bounds visual cue
    const focusBounds = L.latLngBounds([[36.6, -78.0], [37.5, -77.0]]);
    L.rectangle(focusBounds, { color:'#0ea5e9', weight:1, fillOpacity:0.03 }).addTo(map);
  </script>
</body>
</html>
