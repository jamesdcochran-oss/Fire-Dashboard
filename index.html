<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Five Forks Fire Weather Dashboard</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Tiny emoji favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22><text y=%2214%22 font-size=%2214%22>üî•</text></svg>">

  <style>
    :root {
      --bg: #0f172a;
      --fg: #e2e8f0;
      --muted: #8aa0bf;
      --line: #1f2a44;
      --accent: #0ea5e9;
      --cardbg: #0f182c;
      --cardbr: #22314a;
      --chipbg: #0b1529;
      --touch: 44px;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--fg);
      scroll-behavior: smooth;
    }

    /* Overall layout - Mobile first */
    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Desktop grid layout */
    @media screen and (min-width: 900px) {
      body {
        display: grid;
        grid-template-columns: 3fr 1fr;
        grid-template-rows: 1fr;
        gap: 0;
      }
      #map {
        height: 100%;
        grid-column: 1 / 2;
        grid-row: 1 / 2;
      }
      .panel {
        grid-column: 2 / 3;
        grid-row: 1 / 2;
        overflow-y: auto;
      }
    }

    /* Panels and Sheets */
    .panel {
      position: relative;
      background: var(--bg);
      height: fit-content;
      max-width: 100vw;
    }
    .panel .close {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      color: var(--muted);
      cursor: pointer;
    }
    .panel.sheet {
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100%;
      height: 0;
      padding: 0;
      z-index: 1000;
      transition: height 0.3s ease-in-out;
      overflow-y: auto;
      background: #0b1529;
      border-top: 1px solid var(--cardbr);
    }
    .panel.sheet.open {
      height: 50vh;
      padding: 1rem;
    }
    @media screen and (min-width: 900px) {
      .panel.sheet {
        position: static;
        max-height: 100%;
        height: 100%;
        width: 30vw;
        padding: 1rem;
        transition: none;
        overflow: auto;
      }
      .panel.sheet.open {
        height: 100%;
      }
    }
    .panel.sheet h3,
    .panel.sheet h4,
    .panel.sheet p {
      margin: 0.5rem 0;
    }
    .panel.sheet .close {
      display: none;
    }

    /* General Layout and Components */
    #map {
      height: 100%;
      width: 100%;
      flex-grow: 1; /* Map takes remaining space on mobile */
      z-index: 1;
    }
    #controls {
      position: absolute;
      top: 1rem;
      left: 1rem;
      z-index: 999;
      display: flex;
      gap: 0.5rem;
    }
    #controls button, #controls input {
      padding: 0.5rem;
      border: 1px solid var(--cardbr);
      border-radius: 0.25rem;
      background: var(--cardbg);
      color: var(--fg);
    }
    #alerts {
      padding: 1rem;
      border-bottom: 1px solid var(--line);
    }
    .alert-banner {
      background-color: #fca5a5;
      color: #7f1d1d;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border-radius: 0.25rem;
      display: none;
    }
    .alert-banner.active {
      display: block;
    }
    .card-grid {
      display: grid;
      gap: 0.5rem;
      padding: 0.5rem;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }
    .card {
      background: var(--cardbg);
      border: 1px solid var(--cardbr);
      border-radius: 0.5rem;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
    }
    .card:hover {
      box-shadow: 0 0 10px 0 var(--accent);
    }
    .card-title {
      font-weight: bold;
      margin-bottom: 0.25rem;
    }
    .card-temp {
      font-size: 2rem;
      line-height: 1;
      font-weight: 300;
    }
    .card-details {
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 0.5rem;
    }
    .chip {
      background: var(--chipbg);
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      color: var(--fg);
    }
    .list {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }
    .list-item {
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .list-item:last-child {
      border-bottom: none;
    }
    .refresh {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 999;
      background: var(--accent);
      color: var(--bg);
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      font-size: 1.5rem;
      cursor: pointer;
    }
    .blinking-text {
      animation: blink 1s infinite;
    }
    @keyframes blink {
      50% { opacity: 0; }
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 1000;
      transition: opacity 0.5s;
    }
    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .loading-overlay h2 {
      margin-top: 1rem;
    }
    .loading-overlay .spinner {
      font-size: 3rem;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    #settings-panel {
      position: fixed;
      right: -300px;
      top: 0;
      width: 300px;
      height: 100%;
      background: var(--cardbg);
      border-left: 1px solid var(--cardbr);
      z-index: 1000;
      padding: 1rem;
      transition: right 0.3s ease-in-out;
    }
    #settings-panel.open {
      right: 0;
    }
    #settings-panel label, #settings-panel input {
      display: block;
      margin-bottom: 0.5rem;
    }
    .tab-bar {
      display: flex;
      justify-content: space-around;
      border-bottom: 1px solid var(--line);
      margin-bottom: 1rem;
    }
    .tab-bar button {
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 0.5rem;
    }
    .tab-bar button.active {
      color: var(--fg);
      border-bottom: 2px solid var(--accent);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>

  <div id="loading-overlay" class="loading-overlay">
    <div class="spinner">üî•</div>
    <h2>Loading Dashboard...</h2>
  </div>

  <div id="map"></div>

  <div id="controls">
    <button onclick="map.setZoom(map.getZoom() + 1)">+</button>
    <button onclick="map.setZoom(map.getZoom() - 1)">-</button>
    <input type="text" id="search-input" placeholder="Search location..." />
    <button id="search-button">üîç</button>
  </div>

  <div class="panel">
    <div id="alerts">
      <div id="303030" class="alert-banner">
        <h3>Local Fire Weather (30/30/30)</h3>
        <p>Conditions are met in: <span id="303030-counties" class="blinking-text"></span></p>
      </div>
      <h3>Virginia Alerts</h3>
      <ul id="alertList" class="list"></ul>
    </div>
    <div id="overview" class="card-grid"></div>
  </div>

  <button id="settings-button" class="refresh">‚öôÔ∏è</button>
  <div id="settings-panel">
    <div class="close" onclick="document.getElementById('settings-panel').classList.remove('open')">‚úñ</div>
    <h3>Settings</h3>
    <div class="tab-bar">
      <button class="tab-button active" data-tab="alerts">Alerts</button>
      <button class="tab-button" data-tab="display">Display</button>
    </div>
    <div id="alerts-tab" class="tab-content active">
      <p>Customize 30/30/30 Rule Thresholds</p>
      <label>Temperature (¬∞F): <input type="number" id="temp-threshold" min="0"></label>
      <label>Humidity (%): <input type="number" id="humidity-threshold" min="0" max="100"></label>
      <label>Wind Speed (mph): <input type="number" id="wind-threshold" min="0"></label>
    </div>
    <div id="display-tab" class="tab-content">
      <p>Display Settings</p>
      <!-- Future display settings can go here -->
    </div>
  </div>

  <div class="panel sheet" id="sheet">
    <div class="close" id="sheetClose">‚úñ</div>
    <h3 id="sheetTitle"></h3>
    <p id="sheetSub"></p>
    <div class="tab-bar">
      <button class="tab-button active" data-tab="forecast">Forecast</button>
      <button class="tab-button" data-tab="historical">History</button>
    </div>
    <div id="forecast-tab" class="tab-content active">
      <ul id="sheetList" class="list"></ul>
    </div>
    <div id="historical-tab" class="tab-content">
      <canvas id="historicalChart"></canvas>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Constants
    const byId = (id) => document.getElementById(id);
    const COUNTY = [
      { name: 'Amelia', lat: 37.28, lon: -78.01, fires: 3 },
      { name: 'Nottoway', lat: 37.07, lon: -78.02, fires: 1 },
      { name: 'Dinwiddie', lat: 37.10, lon: -77.56, fires: 0 },
      { name: 'Prince George', lat: 37.22, lon: -77.20, fires: 5 },
      { name: 'Brunswick', lat: 36.85, lon: -77.83, fires: 2 },
      { name: 'Greensville', lat: 36.70, lon: -77.53, fires: 0 }
    ];

    // User settings object
    const userSettings = {
      tempThreshold: 86,
      humidityThreshold: 30,
      windThreshold: 18.6
    };
    
    // UI elements
    const map = L.map('map').setView([37.2, -77.5], 9);
    const sheet = byId('sheet');
    let historicalChartInstance = null;
    let mapMarkers = [];

    // Map Layers
    const baseLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    const firmsLayer = L.tileLayer('https://nrt3.modaps.eosdis.nasa.gov/api/v2/content/fires/VNP14IMGTDL_NRT/USA_contiguous_and_Hawaii/{z}/{x}/{y}.png?time=24h', {
      maxZoom: 19,
      attribution: 'FIRMS',
      opacity: 0.7
    }).addTo(map);
    
    // Simulating API calls
    async function getHourly(lat, lon) {
      // Fake delay to show loading state
      await new Promise(resolve => setTimeout(resolve, 500));
      return Array.from({ length: 12 }, (_, i) => ({
        temperature: Math.floor(Math.random() * 20) + 70,
        humidity: Math.floor(Math.random() * 40) + 20,
        windSpeed: Math.floor(Math.random() * 15) + 5,
        hour: (new Date().getHours() + i) % 24
      }));
    }

    async function getVAAlerts() {
      // Fake delay
      await new Promise(resolve => setTimeout(resolve, 500));
      return [
        'Red Flag Warning until 6 PM.',
        'Heat Advisory until 8 PM.'
      ];
    }
    
    // New: Simulated historical data fetch
    async function getHistorical(lat, lon) {
      await new Promise(resolve => setTimeout(resolve, 500));
      return Array.from({ length: 24 }, (_, i) => ({
        time: new Date(new Date().getTime() - (24 - i) * 3600000),
        temp: Math.floor(Math.random() * 20) + 65,
        humidity: Math.floor(Math.random() * 40) + 30,
        wind: Math.floor(Math.random() * 10) + 5
      }));
    }

    // New: Function to render the historical chart
    function renderHistoricalChart(data) {
      const canvas = byId('historicalChart');
      if (historicalChartInstance) {
        historicalChartInstance.destroy();
      }
      historicalChartInstance = new Chart(canvas, {
        type: 'line',
        data: {
          labels: data.map(d => d.time.toLocaleTimeString([], { hour: '2-digit' })),
          datasets: [{
            label: 'Temperature (¬∞F)',
            data: data.map(d => d.temp),
            borderColor: '#fca5a5',
            fill: false,
            yAxisID: 'y'
          }, {
            label: 'Humidity (%)',
            data: data.map(d => d.humidity),
            borderColor: '#93c5fd',
            fill: false,
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: { display: true, text: 'Temp (¬∞F)' }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: { display: true, text: 'Humidity (%)' },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });
    }

    // Existing functions
    async function loadCounty(c) {
      try {
        const periods = await getHourly(c.lat, c.lon);
        const data = periods[0];
        const firesChip = `<span class="chip">${c.fires} recent fires</span>`;
        const cardHtml = `
          <div class="card" onclick="openSheet('${c.name}', ${c.lat}, ${c.lon}, ${c.fires})">
            <div>
              <p class="card-title">${c.name}</p>
              <p class="card-temp">${data.temperature}¬∞</p>
            </div>
            <div class="card-details">
              <p>RH: ${data.humidity}%</p>
              <p>Wind: ${data.windSpeed} mph</p>
              ${c.fires > 0 ? firesChip : ''}
            </div>
          </div>
        `;
        byId('overview').innerHTML += cardHtml;
        return { ...c, data };
      } catch (e) {
        console.error(e);
        return { ...c, data: null };
      }
    }
    
    function render303030(results) {
      const affected = results.filter(r => r.data &&
        r.data.temperature >= userSettings.tempThreshold &&
        r.data.humidity <= userSettings.humidityThreshold &&
        r.data.windSpeed >= userSettings.windThreshold
      ).map(r => r.name);
      const el = byId('303030');
      if (affected.length > 0) {
        el.classList.add('active');
        byId('303030-counties').textContent = affected.join(', ');
      } else {
        el.classList.remove('active');
      }
    }
    
    function renderSheet(periods, title) {
      byId('sheetTitle').textContent = title;
      const html = periods.map(p => `
        <li class="list-item">
          <span>${p.hour}:00</span>
          <span>${p.temperature}¬∞F</span>
          <span>${p.humidity}% RH</span>
          <span>${p.windSpeed} mph</span>
        </li>
      `).join('');
      byId('sheetList').innerHTML = html;
    }
    
    async function loadVAAlerts() {
      try {
        const alerts = await getVAAlerts();
        const html = alerts.map(a => `<li>${a}</li>`).join('');
        byId('alertList').innerHTML = html;
      } catch {
        byId('alertList').innerHTML = `<li>No alerts found.</li>`;
      }
    }
    
    // New: Handles opening the sheet with a specific view
    async function openSheet(title, lat, lon) {
      byId('sheetTitle').textContent = title;
      byId('sheetSub').textContent = '';
      byId('sheetList').innerHTML = `<li class="list-item"><span class="small">Loading...</span></li>`;
      byId('historical-tab').innerHTML = `<p>Loading historical data...</p>`;
      sheet.classList.add('open');
      map.dragging.disable(); map.scrollWheelZoom.disable(); map.boxZoom.disable(); map.keyboard.disable();
      
      try {
        const periods = await getHourly(lat, lon);
        renderSheet(periods, title);
      } catch {
        byId('sheetList').innerHTML = `<li class="list-item"><span class="small">Forecast unavailable</span></li>`;
      }

      try {
        const historicalData = await getHistorical(lat, lon);
        byId('historical-tab').innerHTML = `<canvas id="historicalChart"></canvas>`;
        renderHistoricalChart(historicalData);
      } catch {
        byId('historical-tab').innerHTML = `<p>Historical data unavailable.</p>`;
      }
    }
    
    // New: Map search functionality
    byId('search-button').onclick = async () => {
      const query = byId('search-input').value;
      if (!query) return;
      // This would require a geocoding API, simulating a result
      const lat = 37.1 + (Math.random() - 0.5) * 0.2;
      const lon = -77.5 + (Math.random() - 0.5) * 0.2;
      map.setView([lat, lon], 12);
      
      // Clear previous markers
      mapMarkers.forEach(m => map.removeLayer(m));
      const newMarker = L.marker([lat, lon]).addTo(map).bindPopup(query).openPopup();
      mapMarkers.push(newMarker);
      
      openSheet(query, lat, lon);
    };

    // New: Settings panel logic
    byId('settings-button').onclick = () => {
      const panel = byId('settings-panel');
      panel.classList.toggle('open');
      if (panel.classList.contains('open')) {
        byId('temp-threshold').value = userSettings.tempThreshold;
        byId('humidity-threshold').value = userSettings.humidityThreshold;
        byId('wind-threshold').value = userSettings.windThreshold;
      }
    };

    byId('settings-panel').onchange = () => {
      userSettings.tempThreshold = byId('temp-threshold').value;
      userSettings.humidityThreshold = byId('humidity-threshold').value;
      userSettings.windThreshold = byId('wind-threshold').value;
      // Re-render based on new settings
      refreshAll();
    };
    
    // New: Tab switching logic for the forecast sheet
    document.querySelectorAll('#sheet .tab-bar button').forEach(button => {
      button.onclick = () => {
        document.querySelectorAll('#sheet .tab-bar button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('#sheet .tab-content').forEach(content => content.classList.remove('active'));
        button.classList.add('active');
        byId(button.dataset.tab + '-tab').classList.add('active');
      };
    });
    
    // Existing map click
    map.on('click', async (e) => {
      openSheet('Map Point', e.latlng.lat, e.latlng.lng);
    });
    
    // Existing close button
    byId('sheetClose').onclick = () => {
      sheet.classList.remove('open');
      map.dragging.enable(); map.scrollWheelZoom.enable(); map.boxZoom.disable(); map.keyboard.enable();
    };

    // Initial load
    async function refreshAll() {
      byId('loading-overlay').classList.remove('hidden');
      byId('overview').innerHTML = ''; // Clear existing cards
      loadVAAlerts();
      Promise.all(COUNTY.map(c => loadCounty(c))).then(results => {
        render303030(results);
        byId('loading-overlay').classList.add('hidden');
      });
      map.setZoom(map.getZoom());
    }

    refreshAll();
  </script>

</body>
</html>
