<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Five Forks Fire Weather Dashboard</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Tiny emoji favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22><text y=%2214%22 font-size=%2214%22>üî•</text></svg>">

  <style>
    :root{
      --bg:#0f172a;--fg:#e2e8f0;--muted:#8aa0bf;--line:#1f2a44;--accent:#0ea5e9;
      --cardbg:#0f182c;--cardbr:#22314a;--chipbg:#0b1529;
      --touch:44px;
    }
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    html { scroll-behavior: smooth; background:var(--bg); color:var(--fg); }

    /* Desktop grid */
    #app { display:grid; grid-template-areas:
      'header header'
      'toolbar toolbar'
      'aside map';
      grid-template-columns: 420px 1fr; grid-template-rows: 56px auto 1fr; height:100%; }

    header { grid-area: header; display:flex; align-items:center; justify-content:space-between; padding:8px 12px; background:var(--bg); color:var(--fg); position:sticky; top:0; z-index:5; border-bottom:1px solid var(--line);}
    header .title { font-weight:700; letter-spacing:.2px; }
    header .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .btn { border:0; border-radius:12px; padding:10px 12px; background:#1f2937; color:#e5e7eb; cursor:pointer; font-size:13px; text-decoration:none; display:inline-flex; align-items:center; gap:6px; min-height:var(--touch); }
    .btn:hover { filter:brightness(1.1); }

    /* County cards */
    #toolbar { grid-area: toolbar; border-bottom:1px solid var(--line); background:#0a0f1d; padding:10px 12px; }
    #overview { display:grid; gap:10px; grid-template-columns: repeat(2, 1fr); }
    @media (min-width: 900px){ #overview { grid-template-columns: repeat(3, 1fr); } }

    .ov-card { background:var(--cardbg); border:1px solid var(--cardbr); border-radius:14px; padding:12px; color:#d7e3f7; display:flex; align-items:center; justify-content:space-between; gap:10px; min-height:76px; cursor:pointer; }
    .ov-card:focus-visible { outline:2px solid var(--accent); outline-offset:2px; }
    .ov-main { display:grid; gap:4px; }
    .ov-name { font-weight:700; letter-spacing:.2px; }
    .ov-line { font-size:13px; color:#b9c9e3; }
    .ov-badges { display:flex; gap:6px; align-items:center; }
    .badge { display:inline-flex; align-items:center; gap:6px; border:1px solid var(--cardbr); background:#0b1529; color:#dfe9fb; padding:6px 10px; border-radius:999px; font-size:12px; min-height:var(--touch); }

    /* Aside + Map */
    aside { grid-area: aside; border-right:1px solid var(--line); overflow-y:auto; background: #0b1224; }
    .panel { padding:12px; }
    .section-title { font-size:12px; font-weight:700; text-transform:uppercase; color:#7f8db0; letter-spacing:.5px; margin:10px 0 6px; }
    .card { background:#0f162a; border:1px solid var(--cardbr); border-radius:14px; padding:10px; color:#dbe7ff; }
    .small { font-size:12px; color:#93a3c3; }

    #map { grid-area: map; height:100%; width:100%; }
    .tip { font-size:12px; color:#9fb6d9; margin-top:6px;}

    /* Bottom sheet forecast (mobile ergonomics) */
    #sheet { position:fixed; left:0; right:0; bottom:0; transform:translateY(100%); transition:transform .25s ease; background:#0f162a; color:#dfe7ff; border-top-left-radius:16px; border-top-right-radius:16px; box-shadow:0 -8px 24px rgba(0,0,0,.35); max-height:70vh; display:flex; flex-direction:column; z-index:6; border:1px solid var(--cardbr); }
    #sheet.open { transform:translateY(0); }
    #sheet .handle { align-self:center; width:44px; height:5px; background:#334155; border-radius:999px; margin:8px 0; }
    #sheet .head { padding:0 12px 6px; display:flex; align-items:center; justify-content:space-between; }
    #sheet .body { overflow:auto; padding:0 12px 12px; }
    .forecast-list { list-style:none; padding:0; margin:0; display:grid; gap:4px; }
    .forecast-item { display:flex; align-items:center; justify-content:space-between; border:1px dashed #22314a; padding:6px 8px; border-radius:10px; font-size:13px; background:#0b1224; }

    /* Floating refresh */
    #fabRefresh { position:fixed; right:12px; bottom:12px; z-index:6; box-shadow:0 6px 18px rgba(0,0,0,.25); }

    /* Mobile-first: stack aside ABOVE map */
    @media (max-width: 900px){
      #app { display:block; }
      aside { border-right:0; border-bottom:1px solid var(--line); }
      #map { height:44vh; }
      .panel { padding:12px; }
    }

    /* 30/30/30 alert styles */
    .risk-ok { background:#0b2a13; border-color:#144d25; color:#b7f3c8; }
    .risk-warn { background:#2a190b; border-color:#4d2b14; color:#ffd9b7; }
    .blink { animation: blink 1.25s linear infinite; }
    @keyframes blink { 0%,60%{opacity:1} 61%,100%{opacity:.35} }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="title">üî• Five Forks Fire Weather Dashboard</div>
      <div class="actions">
        <a id="firmsBtn" href="#" class="btn" title="Open FIRMS Map" target="_blank">üåé FIRMS Map</a>
        <a href="https://www.weather.gov/akq" class="btn" target="_blank" title="Open NWS AKQ">üõ∞Ô∏è NWS AKQ</a>
      </div>
    </header>

    <!-- County cards -->
    <section id="toolbar">
      <div id="overview" aria-label="County overview" role="list"></div>
    </section>

    <!-- Aside (alerts, layers, 30/30/30) -->
    <aside>
      <div class="panel">
        <div class="section-title">üî• Local Fire Weather (30/30/30)</div>
        <div id="riskCard" class="card small">Computing local risk‚Ä¶</div>
        <div class="small tip">Temperature is 86F (30C) or above, relative humidity is 30% or less, wind speed is 18.6 mph (30 km/h) or stronger ‚Äî conditions met for extreme fire behavior and difficult to control.</div>

        <div class="section-title" style="margin-top:14px;">‚ö†Ô∏è VA Alerts (NWS)</div>
        <div id="alertsPanel" class="card"><div class="small">Loading active alerts‚Ä¶</div></div>

        <div class="section-title" style="margin-top:14px;">Layers</div>
        <div id="quickLayers" class="card" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
        <div class="small tip">‚ÄúTime Since‚Äù = minutes since each hot pixel was first detected (VIIRS).</div>
      </div>
    </aside>

    <!-- Map -->
    <div id="map" aria-label="Map"></div>
  </div>

  <!-- Bottom sheet for forecast -->
  <section id="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
    <div class="handle"></div>
    <div class="head">
      <div>
        <div id="sheetTitle" style="font-weight:700">Point Forecast</div>
        <div id="sheetSub" class="small"></div>
      </div>
      <button id="sheetClose" class="btn" aria-label="Close forecast">‚úï</button>
    </div>
    <div class="body">
      <ul id="sheetList" class="forecast-list"></ul>
    </div>
  </section>

  <!-- Floating Refresh -->
  <button id="fabRefresh" class="btn" title="Refresh data">üîÑ Refresh</button>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ====== CONFIG ======
    const MAP_KEY = '01e7d5c7c7cd67df54a0e6f08c21e6ab'; // embedded per your note
    const TTL_MS = 15 * 60 * 1000; // hourly forecast cache
    const DAYS = 1;                // FIRMS lookback days
    const HOTPAD = 0.22;           // ~25 km pad for county hotspot counts

    // Counties
    const COUNTY = [
      { id:'amelia',     name:'Amelia',        lat:37.34, lon:-77.98 },
      { id:'nottoway',   name:'Nottoway',      lat:37.14, lon:-78.05 },
      { id:'dinwiddie',  name:'Dinwiddie',     lat:37.08, lon:-77.66 },
      { id:'prgeorge',   name:'Prince George', lat:37.20, lon:-77.22 },
      { id:'brunswick',  name:'Brunswick',     lat:36.77, lon:-77.87 },
      { id:'greensville', name:'Greensville',  lat:36.68, lon:-77.56 }
    ];

    // ====== HELPERS ======
    function byId(id){ return document.getElementById(id); }
    function localHour(iso){ return new Date(iso).toLocaleString([], { hour: 'numeric' }); }
    function parseWindMph(text){
      if(!text) return 0;
      const nums = (text.match(/\d+(\.\d+)?/g)||[]).map(n=>parseFloat(n));
      return nums.length? Math.max(...nums) : 0;
    }
    function in303030(period){
      const T = period?.temperature ?? null;
      const RH = Math.round(period?.relativeHumidity?.value ?? NaN);
      const W = parseWindMph(period?.windSpeed||'');
      return (T!=null && T>=86) && (Number.isFinite(RH) && RH<=30) && (W>=18.6);
    }
    function unionBBox(list){
      let minLat=  90, minLon= 180, maxLat= -90, maxLon= -180;
      list.forEach(c=>{ minLat=Math.min(minLat,c.lat); minLon=Math.min(minLon,c.lon); maxLat=Math.max(maxLat,c.lat); maxLon=Math.max(maxLon,c.lon); });
      return [minLon-0.20, minLat-0.20, maxLon+0.20, maxLat+0.20];
    }

    // ====== MAP ======
    const CENTER = [36.95, -77.50];
    const map = L.map('map').setView(CENTER, 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
    requestAnimationFrame(()=> map.invalidateSize());
    window.addEventListener('resize', ()=> map.invalidateSize());

    // Focus bounds derived from counties
    const ubox = unionBBox(COUNTY);
    const focusBounds = L.latLngBounds([[ubox[1], ubox[0]], [ubox[3], ubox[2]]]);
    L.rectangle(focusBounds, { color:'#0ea5e9', weight:1, fillOpacity:0.03 }).addTo(map);
    map.fitBounds(focusBounds, { padding:[16,16] });

    // Keep map from fighting scroll when sheet is open
    const sheet = byId('sheet');
    const disableMap = ()=>{ map.dragging.disable(); map.scrollWheelZoom.disable(); map.boxZoom.disable(); map.keyboard.disable(); };
    const enableMap  = ()=>{ map.dragging.enable();  map.scrollWheelZoom.enable();  map.boxZoom.enable();  map.keyboard.enable();  };

    // Header FIRMS button ‚Üí FIRMS map viewer at current center/zoom
    function openFirmsMap(){
      const c = map.getCenter(); const z = map.getZoom();
      const url = `https://firms.modaps.eosdis.nasa.gov/usfs/map/#d:today;l:fires_all,fire-perimeter,countries,earth;@${c.lng.toFixed(2)},${c.lat.toFixed(2)},${z.toFixed(2)}z`;
      window.open(url, '_blank');
    }
    byId('firmsBtn').addEventListener('click', (e)=>{ e.preventDefault(); openFirmsMap(); });

    // FIRMS overlays
    const firmsBase = () => `https://firms.modaps.eosdis.nasa.gov/mapserver/wms/fires/${MAP_KEY}/?`;
    const FIRMS = [
      { id:'viirs24', name:'VIIRS 24h', params:{ layers:'fires_viirs_24', format:'image/png', transparent:true, version:'1.1.1' }},
      { id:'modis24', name:'MODIS 24h', params:{ layers:'fires_modis_24', format:'image/png', transparent:true, version:'1.1.1' }},
      { id:'tsd',     name:'Time Since', params:{ layers:'tsd_4_viirs_all', format:'image/png', transparent:true, version:'1.1.1' }},
    ];
    const layers = new Map();
    function addLayer(cfg){ return L.tileLayer.wms(firmsBase(), cfg.params); }
    function buildQuickLayers(){
      const bar = byId('quickLayers'); bar.innerHTML='';
      FIRMS.forEach(cfg=>{
        const b = document.createElement('button'); b.className='btn'; b.style.minHeight='36px'; b.textContent=cfg.name; b.title = (cfg.id==='tsd'?'Minutes since detection (VIIRS)':'Toggle layer');
        const lyr = addLayer(cfg); layers.set(cfg.id, lyr);
        b.onclick = ()=>{ if(map.hasLayer(lyr)){ map.removeLayer(lyr); b.classList.remove('active'); } else { lyr.addTo(map); b.classList.add('active'); } };
        bar.appendChild(b);
        if(cfg.id==='viirs24'){ lyr.addTo(map); b.classList.add('active'); }
      });
    }
    buildQuickLayers();

    // ====== ALERTS ======
    const alertsPanel = byId('alertsPanel');
    const alertsLayer = L.geoJSON(null, { style: { color: '#ef4444', weight: 2, opacity: 0.9, fillOpacity: 0.08 } }).addTo(map);
    async function loadVAAlerts(){
      try{
        alertsPanel.innerHTML='<div class="small">Fetching alerts‚Ä¶</div>';
        const r = await fetch('https://api.weather.gov/alerts/active?area=VA', { headers: { 'Accept': 'application/geo+json' }});
        const j = await r.json();
        alertsLayer.clearLayers(); let count=0;
        (j.features||[]).forEach(f=>{ if(f.geometry){ alertsLayer.addData(f); count++; } });
        alertsPanel.innerHTML = count? `<div class="small">Active alerts in VA: <strong>${count}</strong></div>` : '<div class="small">No active alerts.</div>';
      }catch{
        alertsPanel.innerHTML='<div class="small">Alerts unavailable.</div>';
      }
    }

    // ====== FORECAST CACHE ======
    const FCACHE_KEY = 'ffwd_forecast_cache_v1';
    let forecastCache = {};
    try { const raw = localStorage.getItem(FCACHE_KEY); if (raw) forecastCache = JSON.parse(raw) || {}; } catch {}
    function cacheKey(lat, lon){ return `${lat.toFixed(3)},${lon.toFixed(3)}`; }
    function saveForecastCache(){ try { localStorage.setItem(FCACHE_KEY, JSON.stringify(forecastCache)); } catch {} }

    async function getHourly(lat, lon, {force=false}={}){
      const key = cacheKey(lat, lon); const now = Date.now();
      if(!force){
        const entry = forecastCache[key];
        if(entry && Array.isArray(entry.periods) && entry.periods.length && (now - entry.ts) < TTL_MS){
          return entry.periods;
        }
      }
      const p = await fetch(`https://api.weather.gov/points/${lat.toFixed(4)},${lon.toFixed(4)}`);
      const pj = await p.json(); const hourly = pj?.properties?.forecastHourly;
      if(!hourly) throw new Error('No hourly URL');
      const h = await fetch(hourly); const hj = await h.json();
      const periods = (hj?.properties?.periods||[]);
      forecastCache[key] = { ts: Date.now(), periods }; saveForecastCache();
      return periods;
    }

    // ====== RELIABLE HOTSPOTS (per-county count, VIIRS 24h, de-duped) ======
    function countyBBox(c, pad=HOTPAD){ // lonW, latS, lonE, latN
      return [ (c.lon-pad).toFixed(3), (c.lat-pad).toFixed(3), (c.lon+pad).toFixed(3), (c.lat+pad).toFixed(3) ];
    }
    function firmsCsvUrl({bbox, days=DAYS}){
      if(!MAP_KEY) return null;
      const base = `https://firms.modaps.eosdis.nasa.gov/api/area/csv/${MAP_KEY}/VIIRS_SNPP_NRT,VIIRS_NOAA20_NRT/${days}/${bbox.join(',')}`;
      return `${base}?nocache=${Date.now()}`;
    }
    async function fetchFirmsDedupCount({bbox, timeoutMs=12000}){
      const url = firmsCsvUrl({bbox}); if(!url) return 0;
      const ctrl = new AbortController(); const to = setTimeout(()=>ctrl.abort(), timeoutMs);
      try{
        const r = await fetch(url, { signal: ctrl.signal, headers:{ 'Accept':'text/csv,*/*','Cache-Control':'no-cache' }});
        if(!r.ok) return 0;
        const text = (await r.text()).trim();
        if(!text || /no\s*data|0\s*records/i.test(text)) return 0;
        const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        if(lines.length < 2) return 0;
        const header = lines[0].toLowerCase().split(',').map(h=>h.trim());
        const iLat  = header.indexOf('latitude');
        const iLon  = header.indexOf('longitude');
        const iDate = header.indexOf('acq_date');
        const iTime = header.indexOf('acq_time');
        if(iLat<0 || iLon<0 || iDate<0 || iTime<0) return 0;
        const seen = new Set();
        for(const row of lines.slice(1)){
          const parts = row.split(',');
          const key = [parts[iLat], parts[iLon], parts[iDate], parts[iTime]].join('|');
          if(parts[iLat] && parts[iLon]) seen.add(key);
        }
        return seen.size;
      }catch{ return 0; } finally { clearTimeout(to); }
    }

    // ====== UI BUILD ======
    const overview = byId('overview');
    const countyData = new Map(); // id -> {temp, rh, wind, periods, hotspots}

    function buildOverview(){
      overview.innerHTML='';
      COUNTY.forEach(c=>{
        const card = document.createElement('div'); card.className='ov-card'; card.id = `ov-${c.id}`; card.setAttribute('role','button'); card.setAttribute('tabindex','0');
        card.innerHTML = `
          <div class="ov-main">
            <div class="ov-name">${c.name}</div>
            <div class="ov-line"><span id="ov-t-${c.id}">‚Ä¶</span> ¬∑ RH <span id="ov-r-${c.id}">‚Ä¶</span> ¬∑ <span id="ov-w-${c.id}">‚Ä¶</span></div>
          </div>
          <div class="ov-badges"><span class="badge" title="Hotspots in ~25 km"><span>üî•</span> <span id="ov-hot-${c.id}">‚Ä¶</span></span></div>`;
        card.addEventListener('click', ()=> openCountyForecast(c));
        card.addEventListener('keypress', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); openCountyForecast(c); } });
        overview.appendChild(card);
      });
    }

    function updateCard(c){
      const d = countyData.get(c.id); if(!d) return;
      byId(`ov-t-${c.id}`).textContent = d.temp;
      byId(`ov-r-${c.id}`).textContent = d.rh;
      byId(`ov-w-${c.id}`).textContent = d.wind;
      byId(`ov-hot-${c.id}`).textContent = (d.hotspots==null? 'n/a' : d.hotspots);
    }

    async function loadCounty(c, force=false){
      try{
        const [periods, hotspots] = await Promise.all([
          getHourly(c.lat, c.lon, {force}),
          fetchFirmsDedupCount({ bbox: countyBBox(c) })
        ]);
        const now = periods[0] || {};
        const data = {
          periods,
          temp: (now.temperature!=null? `${now.temperature}¬∞${now.temperatureUnit}` : '‚Äì'),
          rh: (now.relativeHumidity?.value!=null? `${Math.round(now.relativeHumidity.value)}%` : '‚Äì'),
          wind: (now.windSpeed || '‚Äì'),
          hotspots
        };
        countyData.set(c.id, data);
      }catch{
        countyData.set(c.id, { periods:[], temp:'‚Äì', rh:'‚Äì', wind:'‚Äì', hotspots:null });
      }
      updateCard(c);
    }

    // ====== 30/30/30 PANEL ======
    function render303030(){
      const hitters = [];
      COUNTY.forEach(c=>{
        const d = countyData.get(c.id);
        const p = d?.periods?.[0];
        if(p && in303030(p)) hitters.push(c.name);
      });
      const card = byId('riskCard');
      const expl = `Temperature is 86F (30C) or above, relative humidity is 30% or less, wind speed is 18.6 mph (30 km/h) or stronger ‚Äî conditions met for extreme fire behavior and difficult to control.`;
      if(hitters.length){
        card.className = 'card small risk-warn blink';
        card.innerHTML = `<div style="font-weight:700; margin-bottom:6px;">30/30/30 met in: ${hitters.join(', ')}</div><div>${expl}</div>`;
      }else{
        card.className = 'card small risk-ok';
        card.innerHTML = `<div style="font-weight:700; margin-bottom:6px;">30/30/30: not currently met</div><div>${expl}</div>`;
      }
    }

    // ====== FORECAST SHEET ======
    function renderSheet(periods, title){
      byId('sheetTitle').textContent = title || 'Point Forecast';
      byId('sheetSub').textContent = '';
      const list = byId('sheetList');
      list.innerHTML = (periods||[]).slice(0, 12).map(p=>`
        <li class="forecast-item">
          <span>${localHour(p.startTime)}</span>
          <span>${p.temperature}¬∞${p.temperatureUnit}</span>
          <span>RH ${p.relativeHumidity?.value??'‚Äì'}%</span>
          <span>${p.windSpeed}</span>
        </li>`).join('');
      sheet.classList.add('open'); 
      disableMap();
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }
    async function openCountyForecast(c){
      map.setView([c.lat, c.lon], 10);
      byId('sheetTitle').textContent = c.name;
      byId('sheetSub').textContent = '';
      byId('sheetList').innerHTML = `<li class="forecast-item"><span class="small">Loading‚Ä¶</span></li>`;
      sheet.classList.add('open');
      disableMap();
      try{
        const d = countyData.get(c.id);
        const periods = (d && d.periods && d.periods.length)? d.periods : await getHourly(c.lat, c.lon);
        if(!d) countyData.set(c.id, { periods }); else d.periods = periods;
        renderSheet(periods, c.name);
      }catch{
        byId('sheetList').innerHTML = `<li class="forecast-item"><span class="small">Forecast unavailable</span></li>`;
      }
    }
    byId('sheetClose').onclick = ()=> { sheet.classList.remove('open'); enableMap(); };

    // Map click ‚Üí forecast for that point
    map.on('click', async (e)=>{
      byId('sheetTitle').textContent = 'Map Point';
      byId('sheetSub').textContent = '';
      byId('sheetList').innerHTML = `<li class="forecast-item"><span class="small">Loading‚Ä¶</span></li>`;
      sheet.classList.add('open'); 
      disableMap();
      try{
        const periods = await getHourly(e.latlng.lat, e.latlng.lng);
        renderSheet(periods,'Map Point');
      }catch{
        byId('sheetList').innerHTML = `<li class="forecast-item"><span class="small">Forecast unavailable</span></li>`;
      }
    });

    // ====== BOOT ======
    function refreshAll(force=false){
      loadVAAlerts();
      Promise.all(COUNTY.map(c=> loadCounty(c, force))).then(render303030);
      const z=map.getZoom(); map.setZoom(z); // nudge tiles
    }
    function buildOverviewAndStart(){
      buildOverview();
      refreshAll(false);
    }
    buildOverviewAndStart();

    byId('fabRefresh').onclick = ()=> refreshAll(true);
  </script>
</body>
</html>
