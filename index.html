<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- Disable caching on mobile and proxies -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üî• Five Forks Fire Weather</title>

  <!-- Leaflet CSS/JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

  <!-- Turf -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js" defer></script>

  <!-- Leaflet.markercluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js" defer></script>

  <style>
    :root { --bg:#0f172a; --text:#e5e7eb; --card:#111827; --border:#334155; --brand:#3b82f6; --muted:#9ca3af }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{background:var(--brand);color:#fff;padding:.75rem 1rem;display:flex;justify-content:space-between;align-items:center;gap:.5rem;flex-wrap:wrap}
    h1{margin:0;font-size:1.05rem}
    .menu{display:flex;gap:.5rem;flex-wrap:wrap}
    .btn,.menu a,select.btn{background:#fff;color:#111;border:1px solid #e5e7eb;padding:.35rem .6rem;border-radius:9999px;text-decoration:none;font-size:.85rem;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:progress}
    main{display:grid;gap:1rem;padding:1rem}
    .cards{display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:.9rem;box-shadow:0 1px 4px rgba(0,0,0,.25)}
    .meta{font-size:.8rem;color:var(--muted);text-align:right}
    .map-wrap{height:520px;border-radius:14px;overflow:hidden;border:1px solid var(--border)}
    footer{color:var(--muted);text-align:center;padding:1rem}
    .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .5rem;border-radius:9999px;border:1px solid var(--border);background:#fff;color:#111;font-size:.75rem}
    .ok{color:#10b981;border-color:#10b981}.warn{color:#f59e0b;border-color:#f59e0b}.err{color:#ef4444;border-color:#ef4444}
    .flags{display:flex;gap:.35rem;flex-wrap:wrap;margin-top:.35rem}
    .flag{font-weight:700;font-size:.8rem}
    .flash{color:#ef4444;animation:flash 1s steps(2,end) infinite}
    @keyframes flash{50%{opacity:.2}}
    .legend{font-size:.8rem;color:var(--muted)}
    .legend code{background:#0b1225;border:1px solid var(--border);border-radius:6px;padding:.1rem .3rem;color:#e5e7eb}
    details summary{cursor:pointer}
    .leaflet-container{height:100%;width:100%}
    pre.diag{white-space:pre-wrap;margin:0;font-size:.8rem;color:#e5e7eb}
    .fwf-box{max-height:280px;overflow:auto;background:#0b1225;border:1px solid var(--border);border-radius:10px;padding:.75rem;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:.82rem;line-height:1.25;color:#e5e7eb}
    .links{display:flex;gap:.4rem;flex-wrap:wrap}
    .verify{display:inline-flex;gap:.4rem;align-items:center;font-size:.75rem}
  </style>
</head>
<body>
  <header>
    <h1>üî• Five Forks Fire Weather</h1>
    <nav class="menu" aria-label="Primary">
      <button id="unitBtn" class="btn" title="Toggle ¬∞F/¬∞C">¬∞F</button>
      <button id="refreshBtn" class="btn" title="Refresh">üîÑ Refresh</button>
      <label for="radiusSel" class="btn" title="Hotspot radius (km)" style="display:inline-flex;gap:.4rem;align-items:center">
        Radius
        <select id="radiusSel" class="btn" style="margin-left:.25rem">
          <option value="20">20 km</option>
          <option value="30">30 km</option>
          <option value="40">40 km</option>
        </select>
      </label>
      <span id="statusPill" class="pill" aria-live="assertive">‚Äî</span>
      <a href="https://www.weather.gov/akq/" target="_blank" rel="noopener noreferrer">AKQ</a>
      <a href="https://forecast.weather.gov/product.php?site=AKQ&product=FWF" target="_blank" rel="noopener noreferrer">FWF</a>
      <a href="https://forecast.weather.gov/product.php?site=AKQ&product=FWZ" target="_blank" rel="noopener noreferrer">FWZ</a>
      <a href="https://forecast.weather.gov/product.php?product=RFW" target="_blank" rel="noopener noreferrer">RFW</a>
      <a href="https://www.spc.noaa.gov/products/fire_wx/" target="_blank" rel="noopener noreferrer">SPC Fire</a>
    </nav>
  </header>

  <main>
    <div id="rfwBanner" class="pill warn" style="display:none;margin:0 .25rem">Red Flag/Watch active</div>

    <div class="legend">
      <details>
        <summary>‚ÑπÔ∏è Fire weather rules used here</summary>
        <div style="margin-top:.4rem">
          <div><strong>30/30/30 rule</strong>: <code>T ‚â• 30¬∞C (86¬∞F)</code>, <code>RH ‚â§ 30%</code>, <code>Wind ‚â• 30 km/h (~18 mph)</code>. <em>(blinks)</em></div>
          <div>We flag <strong>NEAR</strong> 30/30/30 if within ~10% (or ‚â•2 of 3 near).</div>
        </div>
      </details>
    </div>

    <div id="updated" class="meta">Last updated: ‚Äî</div>

    <!-- FWF panel -->
    <details open>
      <summary><strong>AKQ Fire Weather Forecast (FWF)</strong> <span id="fwfMeta" class="meta" style="margin-left:.5rem"></span></summary>
      <div id="fwfBox" class="fwf-box" aria-live="polite">Loading FWF‚Ä¶</div>
    </details>

    <section id="cards" class="cards" aria-live="polite" aria-busy="false"></section>

    <!-- Diagnostics (show with ?debug=1) -->
    <section id="diag" class="card" style="display:none">
      <strong>Diagnostics</strong>
      <pre class="diag" id="diagPre"></pre>
    </section>

    <section class="map-wrap" aria-label="Active wildfire hotspots map"><div id="map" style="height:100%"></div></section>
  </main>

  <footer>Data: NOAA & NASA FIRMS ‚Ä¢ Updates hourly</footer>

  <script>
    // ---- Version / Cache ----
    const APP_VERSION = '1.8.0';
    document.title = `üî• Five Forks Fire Weather ¬∑ ${APP_VERSION}`;
    const DEBUG = /[?&]debug=1\b/.test(location.search);

    // ---- Config ----
    const WFO = 'AKQ'; // your office
    const COUNTIES = [
      { name: "Amelia",        lat: 37.342, lon: -77.980 },
      { name: "Nottoway",      lat: 37.142, lon: -78.089 },
      { name: "Dinwiddie",     lat: 37.077, lon: -77.587 },
      { name: "Prince George", lat: 37.221, lon: -77.288 },
      { name: "Brunswick",     lat: 36.758, lon: -77.847 },
      { name: "Greensville",   lat: 36.686, lon: -77.542 }
    ];

    // FIRMS sources
    const FIRMS_SOURCES = [
      'https://firms.modaps.eosdis.nasa.gov/active_fire/viirs/geojson/VIIRS_I_NRT_USA_contiguous_and_Hawaii_24h.geojson',
      'https://firms.modaps.eosdis.nasa.gov/active_fire/c6.1/geojson/MODIS_C6_1_USA_contiguous_and_Hawaii_24h.geojson'
    ];
    const ESRI_VIIRS = 'https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Satellite_VIIRS_Thermal_Hotspots_and_Fire_Activity/FeatureServer/0/query';
    const ESRI_MODIS = 'https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Satellite_MODIS_Thermal_Hotspots_and_Fire_Activity/FeatureServer/0/query';

    // ---- State ----
    let unit = localStorage.getItem('ff:unit') || 'F';
    let radiusKm = parseInt(localStorage.getItem('ff:radius') || '30', 10);
    let lastSuccessAt = 0;
    let currentCtrl = null; // AbortController
    const hourlyUrlCache = new Map();

    // ---- Helpers ----
    const $ = sel => document.querySelector(sel);
    function fmtStamp(d=new Date()){ return d.toLocaleString(undefined,{hour12:true}); }
    const toC = f => Math.round(((f-32)*5)/9);
    function setStatus(text, cls){
      const pill = $('#statusPill');
      if(!pill) return;
      pill.className = 'pill ' + (cls||'');
      pill.textContent = text;
      if(cls==='ok' || text==='Fresh'){ pill.style.display='none'; } else { pill.style.display=''; }
    }
    async function fetchJSON(url, { signal, headers } = {}){
      const res = await fetch(url, { signal, headers, cache: 'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status+' for '+url);
      return res.json();
    }
    function el(tag, attrs={}, ...children){
      const node = document.createElement(tag);
      for(const [k,v] of Object.entries(attrs||{})){
        if(k === 'class') node.className = v; else if(k === 'text') node.textContent = v; else node.setAttribute(k, v);
      }
      for(const c of children){ if(typeof c === 'string') node.appendChild(document.createTextNode(c)); else if(c) node.appendChild(c); }
      return node;
    }
    function computeBbox(points, extraKm){
      let minLat=90, maxLat=-90, minLon=180, maxLon=-180;
      for(const p of points){ minLat=Math.min(minLat,p.lat); maxLat=Math.max(maxLat,p.lat); minLon=Math.min(minLon,p.lon); maxLon=Math.max(maxLon,p.lon); }
      const d = (extraKm||0)/111;
      return [ (minLon-d).toFixed(4), (minLat-d).toFixed(4), (maxLon+d).toFixed(4), (maxLat+d).toFixed(4) ];
    }
    // RH from T, Td (fallback only). Inputs ¬∞C.
    function rhFrom(Tc, Tdc){
      if(!Number.isFinite(Tc) || !Number.isFinite(Tdc)) return null;
      const a=17.625, b=243.04;
      const es = 6.112 * Math.exp((a*Tc)/(b+Tc));
      const e  = 6.112 * Math.exp((a*Tdc)/(b+Tdc));
      return 100*(e/es);
    }
    function parseWindMph(s){ const nums = (s||'').match(/\d+/g)||[]; return nums.length? Math.max(...nums.map(n=>parseInt(n,10))) : null; }
    function flags303030(tempF, rh, windStr){
      const tempC = (tempF!=null)? (tempF-32)*5/9 : null; const windMph = parseWindMph(windStr);
      const within = (tempC!=null && rh!=null && windMph!=null) && tempC>=30 && rh<=30 && windMph>=18;
      const near = !within && ( ((tempC!=null && tempC>=28)?1:0) + ((rh!=null && rh<=33)?1:0) + ((windMph!=null && windMph>=16)?1:0) ) >= 2;
      return { within, near };
    }

    // ---- NWS Fire Weather products (FWF) ----
    async function fetchFWF(site, signal){
      const idx = await fetchJSON(`https://api.weather.gov/products/types/FWF/locations/${site}`, { signal, headers:{'Accept':'application/geo+json'} });
      const latest = idx?.['@graph']?.[0]?.['@id'] || null;
      if(!latest) return { text:null, issued:null };
      const full = await fetchJSON(latest, { signal });
      const text = full?.productText || null;
      const issued = full?.issuanceTime || full?.issuanceTimeLocal || full?.['@issued'] || null;
      return { text, issued };
    }

    // ---- Weather ----
    async function fetchWeather(lat, lon, signal){
      try{
        const key = lat.toFixed(3)+","+lon.toFixed(3);
        let hourlyUrl = hourlyUrlCache.get(key);
        if(!hourlyUrl){
          const meta = await fetchJSON(`https://api.weather.gov/points/${lat},${lon}`, { signal, headers:{'Accept':'application/geo+json','Cache-Control':'no-cache'} });
          hourlyUrl = meta?.properties?.forecastHourly; if(!hourlyUrl) throw new Error('No hourly URL');
          hourlyUrlCache.set(key, hourlyUrl);
        }
        const bust = `v=${Date.now()}`;
        const sep  = hourlyUrl.includes('?') ? '&' : '?';
        const hourlyNoCache = hourlyUrl + sep + bust;

        const data = await fetchJSON(hourlyNoCache, { signal, headers:{'Accept':'application/geo+json','Cache-Control':'no-cache'} });
        const p = data?.properties?.periods?.[0]; if(!p) return null;

        const tempF = Number.isFinite(p?.temperature) ? p.temperature : null;

        const rhRaw = p?.relativeHumidity?.value;
        const rh = (typeof rhRaw === 'number') ? rhRaw : (rhRaw == null ? null : Number(rhRaw));

        const dpRaw = p?.dewpoint?.value; // ¬∞C
        const dpC = (typeof dpRaw === 'number') ? dpRaw : (dpRaw == null ? null : Number(dpRaw));

        return {
          tempF,
          rh,                 // float %
          dpC,                // ¬∞C
          wind: [p.windSpeed||'', p.windDirection||''].filter(Boolean).join(' '),
          short: p.shortForecast || '‚Äî',
          verifyUrl: `https://forecast.weather.gov/MapClick.php?lat=${lat}&lon=${lon}&FcstType=graphical`
        };
      }catch(e){ console.warn('NOAA fetch error', e); return null; }
    }

    async function fetchAllFirms(signal){
      try{
        const results = await Promise.allSettled(FIRMS_SOURCES.map(u => fetchJSON(u, { signal })));
        const collections = results.filter(r => r.status==='fulfilled').map(r => r.value);
        const seen = new Set(); const out = [];
        for(const col of collections){ const feats = col?.features || [];
          for(const f of feats){ if(!(f && f.geometry && f.geometry.type==='Point')) continue;
            const [x,y]=f.geometry.coordinates||[]; if(!Number.isFinite(x)||!Number.isFinite(y)) continue;
            const key=x.toFixed(3)+","+y.toFixed(3); if(!seen.has(key)){ seen.add(key); out.push(f);} }
        }
        if(out.length){ return { type:'FeatureCollection', features: out }; }
      }catch(err){ console.warn('NASA FIRMS fetch failed, using Esri fallback', err); }

      const [xmin,ymin,xmax,ymax] = computeBbox(COUNTIES, Math.max(radiusKm, 60));
      const common = { geometry: `${xmin},${ymin},${xmax},${ymax}`, geometryType: 'esriGeometryEnvelope', inSR: '4326', spatialRel: 'esriSpatialRelIntersects', outFields: '*', outSR: '4326', f: 'geojson' };
      const viirsParams = new URLSearchParams({ ...common, where: 'hours_old<=24' });
      const modisParams = new URLSearchParams({ ...common, where: 'hours_old<=48' });
      const viirsUrl = `${ESRI_VIIRS}?${viirsParams.toString()}`;
      const modisUrl = `${ESRI_MODIS}?${modisParams.toString()}`;
      try{
        const [vj, mj] = await Promise.allSettled([ fetchJSON(viirsUrl,{signal}), fetchJSON(modisUrl,{signal}) ]);
        const collections = [vj, mj].filter(r=>r.status==='fulfilled').map(r=>r.value);
        const seen = new Set(); const out = [];
        for(const col of collections){ const feats = col?.features || [];
          for(const f of feats){ if(!(f && f.geometry && f.geometry.type==='Point')) continue;
            const [x,y]=f.geometry.coordinates||[]; if(!Number.isFinite(x)||!Number.isFinite(y)) continue;
            const key=x.toFixed(3)+","+y.toFixed(3); if(!seen.has(key)){ seen.add(key); out.push(f);} }
        }
        return { type:'FeatureCollection', features: out };
      }catch(e){ console.warn('Esri fallback error', e); return { type:'FeatureCollection', features: [] }; }
    }

    function renderCard(name, wx, hotspots, lat, lon){
      const tempF = (wx && Number.isFinite(wx.tempF)) ? wx.tempF : null;
      const tempText = (tempF!=null) ? (unit==='C'? toC(tempF)+'¬∞C' : Math.round(tempF)+'¬∞F') : '‚Äî';
      const tempC = tempF!=null ? (tempF - 32) * 5 / 9 : null;

      // RH display: round only here; clamp to [1,100]
      const rhVal = (wx && Number.isFinite(wx.rh)) ? wx.rh : null;
      let rhDisplay = null;
      if(rhVal != null){
        rhDisplay = Math.max(1, Math.min(100, Math.round(rhVal)));
      }else if(Number.isFinite(wx?.dpC) && tempC != null){
        const r = rhFrom(tempC, wx.dpC);
        rhDisplay = r==null ? null : Math.max(1, Math.min(100, Math.round(r)));
      }
      const rhText = (rhDisplay!=null) ? rhDisplay + "% RH" : "‚Äî% RH";

      // dewpoint display; cap to T for display if >T due to noise
      let dpC = Number.isFinite(wx?.dpC) ? wx.dpC : null;
      if(dpC!=null && tempC!=null && dpC > tempC + 0.5) dpC = tempC;
      const dpText = (dpC!=null)
        ? (unit==='C' ? Math.round(dpC)+'¬∞C' : Math.round((dpC*9/5)+32)+'¬∞F')
        : '‚Äî';

      const wind = (wx && wx.wind) ? ' ¬∑ '+wx.wind : '';
      const hs = Number.isFinite(hotspots) ? ` ¬∑ üî• ${hotspots}` : '';

      const f3030 = wx ? flags303030(tempF, rhDisplay, wx.wind) : { within:false, near:false };
      const flagsEl = el('div', { class:'flags' });
      if(f3030.within){ flagsEl.appendChild(el('span',{ class:'flag flash', title:'30/30/30 met: T‚â•30¬∞C, RH‚â§30%, Wind‚â•30 km/h', text:'30/30/30' })); }
      else if(f3030.near){ flagsEl.appendChild(el('span',{ class:'flag flash', title:'Near 30/30/30 (within ~10%)', text:'NEAR 30/30/30' })); }

      // Verify links
      const verify = el('div', { class:'links', style:'margin-top:.4rem' },
        el('a', { class:'verify', href: wx?.verifyUrl || '#', target:'_blank', rel:'noopener noreferrer' , title:'NWS Hourly Graphical' }, 'Verify: NWS Hourly'),
        el('a', { class:'verify', href:`https://www.google.com/maps?q=${lat},${lon}`, target:'_blank', rel:'noopener noreferrer'}, 'Map')
      );

      return el('div', { class:'card' },
        el('strong', { text:name }),
        el('br'),
        el('span', { text: `${tempText} ¬∑ ${rhText} ¬∑ DP ${dpText}${wind}` }),
        el('br'),
        el('span', { text: (wx?wx.short:'Weather unavailable') + hs }),
        flagsEl,
        verify
      );
    }

    function countHotspotsNear(geojson, lat, lon, km){
      if(!geojson?.features?.length) return 0;
      const circle = turf.circle([lon, lat], km, { units:'kilometers' });
      const coords = [];
      for(const f of geojson.features){ if(f.geometry && f.geometry.type === 'Point') coords.push(f.geometry.coordinates); }
      if(!coords.length) return 0;
      const pts = turf.points(coords);
      const inside = turf.pointsWithinPolygon(pts, circle);
      return inside.features.length;
    }

    function showDiag(rows){
      if(!DEBUG) return;
      const box = $('#diag'); const pre = $('#diagPre');
      if(!box || !pre) return;
      box.style.display = '';
      pre.textContent = rows.map(r =>
        `${r.name}: T=${r.T_F?.toFixed?.(1) ?? '‚Äî'}¬∞F  Tc=${r.T_C?.toFixed?.(1) ?? '‚Äî'}¬∞C  TdC=${r.Td_C?.toFixed?.(1) ?? '‚Äî'}¬∞C  RH=${r.RH?.toFixed?.(1) ?? '‚Äî'}%  RHshow=${r.RHshow ?? '‚Äî'}`
      ).join('\n');
    }

    async function fetchRFW(lat, lon, signal){
      const url = `https://api.weather.gov/alerts/active?point=${lat},${lon}&event=Red%20Flag%20Warning,Fire%20Weather%20Watch`;
      try{
        const j = await fetchJSON(url, {signal, headers:{'Accept':'application/geo+json'}});
        return (j.features||[]).length > 0;
      }catch{ return false; }
    }

    async function refresh(){
      if(currentCtrl) currentCtrl.abort();
      const ctrl = new AbortController(); currentCtrl = ctrl;

      setStatus('Loading‚Ä¶');
      $('#refreshBtn').setAttribute('disabled','true');
      $('#cards').setAttribute('aria-busy','true');
      $('#updated').textContent = 'Last updated: ' + fmtStamp() + ' ¬∑ v' + APP_VERSION;

      try{
        // Pull FWF + RFW + Weather + FIRMS in parallel
        const [fwf, anyRFW, firms, wxResults] = await Promise.all([
          fetchFWF(WFO, ctrl.signal),
          (async ()=>{ // any RFW across counties
            const flags = await Promise.all(COUNTIES.map(c => fetchRFW(c.lat, c.lon, ctrl.signal)));
            return flags.some(Boolean);
          })(),
          fetchAllFirms(ctrl.signal),
          Promise.all(COUNTIES.map(c => fetchWeather(c.lat, c.lon, ctrl.signal)))
        ]);

        // Render FWF panel
        const fwfBox = $('#fwfBox'); const fwfMeta = $('#fwfMeta');
        if(fwf?.text){
          fwfBox.textContent = fwf.text.trim();
          fwfMeta.textContent = fwf.issued ? `Issued: ${new Date(fwf.issued).toLocaleString()}` : '';
        }else{
          fwfBox.textContent = 'FWF unavailable.';
          fwfMeta.textContent = '';
        }

        // RFW banner
        $('#rfwBanner').style.display = anyRFW ? '' : 'none';

        // Cards
        const frag = document.createDocumentFragment();
        COUNTIES.forEach((c, i) => {
          const hs = countHotspotsNear(firms, c.lat, c.lon, radiusKm);
          frag.appendChild(renderCard(c.name, wxResults[i], hs, c.lat, c.lon));
        });
        $('#cards').replaceChildren(frag);

        if(DEBUG){
          const diagRows = COUNTIES.map((c,i) => {
            const w = wxResults[i] || {};
            const T_F = Number.isFinite(w.tempF) ? w.tempF : null;
            const T_C = T_F!=null ? (T_F-32)*5/9 : null;
            const Td_C = Number.isFinite(w.dpC) ? w.dpC : null;
            const RH = Number.isFinite(w.rh) ? w.rh : null;
            const RHshow = RH==null ? null : Math.max(1, Math.min(100, Math.round(RH)));
            return { name:c.name, T_F, T_C, Td_C, RH, RHshow };
          });
          showDiag(diagRows);
        }
