<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Five Forks Fire Weather — Live Status</title>
  <style>
    :root { --bg:#111; --fg:#eee; --card:#1e1e1e; --muted:#a8a8a8; --accent:#ff9933; --ok:#5bd67a }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial; background:var(--bg); color:var(--fg); display:flex; flex-direction:column; align-items:center; }
    header { padding:16px; text-align:center; font-weight:700; font-size:20px; }
    main { max-width:760px; width:100%; padding:12px; display:grid; gap:12px; }
    .map { height:200px; border-radius:16px; background:#2a2a2a; display:grid; place-items:center; color:var(--muted); }
    .card { background:var(--card); border:1px solid #2b2b2b; border-radius:16px; padding:16px; box-shadow: 0 4px 18px rgba(0,0,0,.25); }
    .hot-row { display:flex; align-items:baseline; justify-content:center; gap:10px; }
    .hot-count { font-size:44px; font-weight:800; color:var(--accent); line-height:1; min-width:3ch; text-align:center; }
    .hot-label { font-size:14px; color:var(--muted); }
    .badge { font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #444; background:#1a1a1a; color:var(--muted); }
    .badge.live { color: var(--ok); border-color: #2f7042; background:#132d1b; }
    .badge.off  { color: #bbbbbb; border-color: #555; background:#1e1e1e; }
    .meta { display:flex; gap:12px; justify-content:center; font-size:12px; color:var(--muted); margin-top:8px; flex-wrap:wrap; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:10px; }
    .county { background:var(--card); border:1px solid #2b2b2b; border-radius:14px; padding:12px; text-align:center; }
    .county .name { font-weight:700; margin-bottom:6px; }
    footer { text-align:center; color:var(--muted); font-size:12px; padding:16px 0 24px; }
    code { background:#000; color:#eee; padding:2px 6px; border-radius:6px; }
    details { border:1px solid #2b2b2b; border-radius:12px; padding:10px 12px; }
    details > summary { cursor:pointer; color:var(--muted); }
    pre.log { white-space:pre-wrap; background:#0b0b0b; border-radius:8px; padding:8px; border:1px solid #222; max-height:220px; overflow:auto; }
    .btns { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    button { background:#ececec; color:#111; border:0; border-radius:999px; padding:6px 12px; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
  </style>
</head>
<body>
  <header>Five Forks Fire Weather — Live Status</header>
  <main>
    <div class="map">[ Map Placeholder ]</div>

    <section class="card">
      <div class="hot-row">
        <span id="modeBadge" class="badge off">OFFLINE</span>
        <div id="hotspotTotal" class="hot-count">—</div>
        <div class="hot-label">Hotspots (24h, deduped)</div>
      </div>
      <div class="meta">
        <div>Updated: <span id="updatedAt">—</span></div>
        <div>BBox: <span id="bboxText">—</span></div>
        <div>Lookback: <span id="daysText">1 day</span></div>
      </div>
      <div class="btns" style="margin-top:10px">
        <button id="btnRetry">Retry</button>
        <button id="btnMock">Use Mock</button>
        <button id="btnLive">Use Live</button>
      </div>
    </section>

    <section class="grid">
      <div class="county"><div class="name">Amelia</div><div>Forecast…</div></div>
      <div class="county"><div class="name">Nottoway</div><div>Forecast…</div></div>
      <div class="county"><div class="name">Dinwiddie</div><div>Forecast…</div></div>
      <div class="county"><div class="name">Prince George</div><div>Forecast…</div></div>
      <div class="county"><div class="name">Brunswick</div><div>Forecast…</div></div>
      <div class="county"><div class="name">Greensville</div><div>Forecast…</div></div>
    </section>

    <details>
      <summary>Diagnostics & Tests</summary>
      <div style="margin:10px 0; font-size:12px; color:var(--muted)">
        On failure (e.g., CORS/network or missing/invalid <code>MAP_KEY</code>) the count shows <b>N/A</b> and the card marks <b>OFFLINE</b>. Use <b>Use Mock</b> to preview a number.
      </div>
      <div id="testResults" class="card" style="font-size:13px"></div>
      <pre id="diag" class="log"></pre>
    </details>
  </main>
  <footer>
    Static client-side status page.
  </footer>

  <script>
    // ===== CONFIG (PUBLIC if committed) =====
    const EMBEDDED_MAP_KEY = "01e7d5c7c7cd67df54a0e6f08c21e6ab"; // <-- your key
    const DAYS = getIntParam('days', 1);           // ?days=2 to test
    const PAD_DEG = parseFloatParam('pad', 0.08);  // ?pad=0.1 to test
    const FORCE_MOCK = getBoolParam('mock', false);// ?mock=1 to force mock number

    // Six counties (lat/lon)
    const COUNTIES = [
      { name: "Amelia",        lat: 37.340, lon: -77.980 },
      { name: "Nottoway",      lat: 37.140, lon: -78.050 },
      { name: "Dinwiddie",     lat: 37.070, lon: -77.580 },
      { name: "Prince George", lat: 37.220, lon: -77.290 },
      { name: "Brunswick",     lat: 36.770, lon: -77.880 },
      { name: "Greensville",   lat: 36.680, lon: -77.540 },
    ];

    // ===== Utilities =====
    function getIntParam(k, def){ const v = new URLSearchParams(location.search).get(k); const n = v==null?NaN:parseInt(v,10); return Number.isFinite(n)? n: def; }
    function parseFloatParam(k, def){ const v = new URLSearchParams(location.search).get(k); const n = v==null?NaN:parseFloat(v); return Number.isFinite(n)? n: def; }
    function getBoolParam(k, def){ const v = new URLSearchParams(location.search).get(k); if(v==null) return def; return v==='' || v==='1' || v.toLowerCase()==='true'; }
    function log(msg){ const pre = document.getElementById('diag'); pre.textContent += (msg + "\n"); }
    function setText(id, val){ const el = document.getElementById(id); if (el) el.textContent = val; }
    function fmtBBox(b){ return `[${b[0]}, ${b[1]}] → [${b[2]}, ${b[3]}]`; }
    function nowET(){ try { return new Date().toLocaleString('en-US',{timeZone:'America/New_York', hour12:false}) + ' ET'; } catch { return new Date().toISOString(); } }
    function unionBBox(counties, padDeg = PAD_DEG){
      const lats = counties.map(c => c.lat);
      const lons = counties.map(c => c.lon);
      let minLat = Math.max(Math.min(...lats) - padDeg, -90);
      let maxLat = Math.min(Math.max(...lats) + padDeg,  90);
      let minLon = Math.max(Math.min(...lons) - padDeg, -180);
      let maxLon = Math.min(Math.max(...lons) + padDeg,  180);
      return [minLon, minLat, maxLon, maxLat].map(v => Number(v).toFixed(3));
    }

    // ===== Mock CSV (for optional offline demo) =====
    const MOCK_CSV = `latitude,longitude,bright_ti4,acq_date,acq_time,satellite,instrument,confidence,version,bright_ti5,frp,daynight\n\n37.1,-77.9,330.1,2025-09-05,1740,N,VIIRS,high,2.0,310.2,11.2,D\n\n37.1,-77.9,329.8,2025-09-05,1740,J,VIIRS,high,2.0,310.0,11.0,D\n\n36.9,-77.7,331.0,2025-09-05,1742,N,VIIRS,high,2.0,311.0,12.0,D`;

    // ===== CSV Parser + Dedupe =====
    function parseDedupCount(csvText){
      const text = (csvText || '').trim();
      if (!text) return { dedup: 0, raw: 0 };
      const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      if (!lines.length) return { dedup: 0, raw: 0 };
      const header = lines[0].split(',').map(h => h.toLowerCase());
      const idxLat = header.indexOf('latitude');
      const idxLon = header.indexOf('longitude');
      const idxDate = header.indexOf('acq_date');
      const idxTime = header.indexOf('acq_time');
      const hasViirs = header.some(h => h.includes('bright_ti4') || h.includes('bright_ti5') || h.includes('bright_ti'));
      if (idxLat < 0 || idxLon < 0 || idxDate < 0 || idxTime < 0 || !hasViirs) return { dedup: 0, raw: 0 };
      const seen = new Set();
      let raw = 0;
      for (const row of lines.slice(1)){
        const parts = row.split(',');
        if (parts.length <= Math.max(idxLat, idxLon, idxDate, idxTime)) continue;
        const plat = parseFloat(parts[idxLat]);
        const plon = parseFloat(parts[idxLon]);
        if (!Number.isFinite(plat) || !Number.isFinite(plon)) continue;
        if (plat < -90 || plat > 90 || plon < -180 || plon > 180) continue;
        raw++;
        seen.add(`${parts[idxLat]}|${parts[idxLon]}|${parts[idxDate] || ''}|${parts[idxTime] || ''}`);
      }
      return { dedup: seen.size, raw };
    }

    // ===== FIRMS Fetch (graceful failure → N/A) =====
    function resolveMapKey(){
      return (EMBEDDED_MAP_KEY && EMBEDDED_MAP_KEY.trim()) || (window.MAP_KEY || '').trim();
    }

    async function fetchFirmsCSV({ bbox, days=DAYS, timeoutMs=9000 }){
      const key = resolveMapKey();
      if (!key) throw new Error('MAP_KEY missing');
      const url = `https://firms.modaps.eosdis.nasa.gov/api/area/csv/${key}/VIIRS_SNPP_NRT,VIIRS_NOAA20_NRT/${days}/${bbox.join(',')}`;
      const ctrl = new AbortController();
      const to = setTimeout(() => ctrl.abort(), timeoutMs);
      try {
        const r = await fetch(url, { signal: ctrl.signal, headers: { 'Accept':'text/csv,*/*', 'Cache-Control':'no-cache' } });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const text = (await r.text()).trim();
        if (!text || /no\s*data|0\s*records/i.test(text)) return '';
        return text;
      } finally { clearTimeout(to); }
    }

    async function getDedupCountLive(bbox){
      try {
        const csv = await fetchFirmsCSV({ bbox });
        if (!csv) return { dedup: 0, raw: 0, mode: 'LIVE' };
        const res = parseDedupCount(csv);
        res.mode = 'LIVE';
        return res;
      } catch (e) {
        log(`[live] fetch failed: ${e?.message || e}`);
        return { dedup: null, raw: null, mode: 'LIVE_FAIL', error: String(e) };
      }
    }

    function setModeBadge(mode){
      const b = document.getElementById('modeBadge');
      b.classList.remove('live','off');
      if (mode === 'LIVE') { b.textContent = 'LIVE'; b.classList.add('live'); }
      else { b.textContent = 'OFFLINE'; b.classList.add('off'); }
    }

    async function refresh({ forceMock = FORCE_MOCK } = {}){
      setText('daysText', DAYS === 1 ? '1 day' : `${DAYS} days`);
      setText('hotspotTotal', '…');
      const bbox = unionBBox(COUNTIES);
      setText('bboxText', fmtBBox(bbox));

      if (forceMock) {
        setModeBadge('OFFLINE');
        const r = parseDedupCount(MOCK_CSV);
        setText('hotspotTotal', String(r.dedup));
        setText('updatedAt', nowET());
        return;
      }

      const live = await getDedupCountLive(bbox);
      if (live.dedup !== null) {
        setModeBadge('LIVE');
        setText('hotspotTotal', String(live.dedup));
        setText('updatedAt', nowET());
        return;
      }

      setModeBadge('OFFLINE');
      setText('hotspotTotal', 'N/A');
      setText('updatedAt', nowET());
    }

    document.getElementById('btnRetry').addEventListener('click', () => refresh({ forceMock:false }));
    document.getElementById('btnMock').addEventListener('click', () => refresh({ forceMock:true }));
    document.getElementById('btnLive').addEventListener('click', () => refresh({ forceMock:false }));

    // ===== Self-tests =====
    function runTests(){
      const out = [];
      function assertEq(name, got, exp){ out.push(`${name}: ${got===exp? 'PASS':'FAIL'} (got ${got}, expected ${exp})`); }
      const r1 = parseDedupCount(MOCK_CSV); assertEq('Dedup basic', r1.dedup, 2); assertEq('Raw count', r1.raw, 3);
      const r2 = parseDedupCount('No Data'); assertEq('No data -> 0', r2.dedup, 0);
      const r3 = parseDedupCount('lat,lon\n1,2'); assertEq('Bad header -> 0', r3.dedup, 0);
      document.getElementById('testResults').textContent = out.join('\n');
    }

    (async () => {
      runTests();
      await refresh({ forceMock: FORCE_MOCK });
      setInterval(refresh, 30*60*1000);
    })();
  </script>
</body>
</html>
