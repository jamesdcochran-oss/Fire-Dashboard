<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Five Forks Fire Weather Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --bg:#0f172a;--fg:#e2e8f0;--muted:#64748b;--line:#e5e7eb;--accent:#0ea5e9;--chip:#0b1220;
      --touch:44px; /* min touch target */
    }
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }

    /* Layout */
    #app { display:grid; grid-template-areas:
      'header header'
      'toolbar toolbar'
      'map aside';
      grid-template-columns: 1fr 460px; grid-template-rows: 56px auto 1fr; height:100%; }

    header { grid-area: header; display:flex; align-items:center; justify-content:space-between; padding:8px 12px; background:var(--bg); color:var(--fg); position:sticky; top:0; z-index:5; }
    header .title { font-weight:700; letter-spacing:.2px; }
    header .actions { display:flex; gap:8px; }
    .btn { border:0; border-radius:12px; padding:10px 12px; background:#1f2937; color:#e5e7eb; cursor:pointer; font-size:13px; text-decoration:none; display:inline-flex; align-items:center; gap:6px; min-height:var(--touch); }
    .btn:hover { filter:brightness(1.1); }

    /* Toolbar (DATA-FIRST): county chips, quick layers, overview cards */
    #toolbar { grid-area: toolbar; border-bottom:1px solid var(--line); background:#0a0f1d; padding:10px 12px; }
    .chip-row { display:flex; gap:8px; overflow-x:auto; scrollbar-width:thin; }
    .chip { flex:0 0 auto; display:flex; align-items:center; gap:8px; border:1px solid #243044; color:#d7e3f7; background:linear-gradient(180deg,#0e1627,#0a1120); padding:8px 10px; border-radius:999px; min-height:var(--touch); min-width:140px; cursor:pointer; }
    .chip .name { font-weight:700; letter-spacing:.1px; }
    .chip .met { font-size:12px; color:#aebcd3; }
    .chip .dot { width:8px; height:8px; border-radius:999px; background:#94a3b8; }
    .chip.active { outline:2px solid var(--accent); }

    #quickLayers { display:flex; gap:6px; margin-top:8px; flex-wrap:wrap; }
    #quickLayers .seg { flex:0 0 auto; border:1px solid #203049; background:#0f182c; color:#d7e3f7; border-radius:10px; padding:6px 10px; font-size:12px; cursor:pointer; }
    #quickLayers .seg.active { background:var(--accent); color:white; border-color:var(--accent); }

    /* Overview cards (DRIVES ACTION) */
    #overview { margin-top:10px; display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px; }
    .ov-card { background:#0f182c; border:1px solid #22314a; border-radius:14px; padding:10px; color:#d7e3f7; cursor:pointer; }
    .ov-title { display:flex; align-items:center; justify-content:space-between; font-weight:700; margin-bottom:6px; }
    .ov-kpis { display:grid; grid-template-columns: repeat(4, 1fr); gap:6px; }
    .ov-kpi { background:#0b1529; border:1px solid #22314a; border-radius:10px; padding:6px; text-align:center; font-size:12px; }
    .ov-kpi .lbl { display:block; color:#9fb1cf; font-size:11px; }

    /* Map + Aside */
    #map { grid-area: map; height:100%; width:100%; }
    aside { grid-area: aside; border-left:1px solid var(--line); overflow-y:auto; }
    .panel { padding:12px; }
    .section-title { font-size:12px; font-weight:700; text-transform:uppercase; color:#475569; letter-spacing:.5px; margin:10px 0 6px; }
    .card { background:#ffffff; border:1px solid var(--line); border-radius:14px; padding:10px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .small { font-size:12px; color:var(--muted); }

    /* Bottom sheet forecast (mobile ergonomics) */
    #sheet { position:fixed; left:0; right:0; bottom:0; transform:translateY(100%); transition:transform .25s ease; background:#ffffff; border-top-left-radius:16px; border-top-right-radius:16px; box-shadow:0 -8px 24px rgba(0,0,0,.2); max-height:70vh; display:flex; flex-direction:column; z-index:6; }
    #sheet.open { transform:translateY(0); }
    #sheet .handle { align-self:center; width:44px; height:5px; background:#cbd5e1; border-radius:999px; margin:8px 0; }
    #sheet .head { padding:0 12px 6px; display:flex; align-items:center; justify-content:space-between; }
    #sheet .body { overflow:auto; padding:0 12px 12px; }
    .forecast-list { list-style:none; padding:0; margin:0; display:grid; gap:6px; }
    .forecast-item { display:flex; align-items:center; justify-content:space-between; border:1px dashed var(--line); padding:6px 8px; border-radius:10px; font-size:13px; }

    /* Floating refresh */
    #fabRefresh { position:fixed; right:12px; bottom:12px; z-index:6; box-shadow:0 6px 18px rgba(0,0,0,.25); }

    /* Mobile tweaks */
    @media (max-width: 900px){
      #app { grid-template-areas:
        'header'
        'toolbar'
        'map'
        'aside'; grid-template-columns:1fr; grid-template-rows:56px auto 44vh auto; }
      aside { border-left:0; border-top:1px solid var(--line); }
      .panel { padding:12px; }
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="title">üî• Five Forks Fire Weather Dashboard</div>
      <div class="actions">
        <a id="firmsBtn" href="#" class="btn" title="Open FIRMS Map" target="_blank">üåé FIRMS Map</a>
        <a href="https://www.weather.gov/akq" class="btn" target="_blank" title="Open NWS AKQ">üõ∞Ô∏è NWS AKQ</a>
      </div>
    </header>

    <!-- DATA-FIRST TOOLBAR: chips + quick toggles + overview cards ABOVE the map -->
    <section id="toolbar">
      <div id="chipRow" class="chip-row" aria-label="Counties"></div>
      <div id="quickLayers" aria-label="FIRMS layers"></div>
      <div id="overview" aria-label="County overview"></div>
    </section>

    <div id="map"></div>

    <aside>
      <div class="panel">
        <div class="section-title">‚ö†Ô∏è VA Alerts (NWS)</div>
        <div id="alertsPanel" class="card"><div class="small">Loading active alerts‚Ä¶</div></div>
        <div class="section-title">About</div>
        <div class="card small">This layout prioritizes **weather intelligence**. Use the overview cards to scan Temp/RH/Wind/Hotspots per county, then tap any card for the detailed hourly sheet. The map is supportive context.</div>
      </div>
    </aside>
  </div>

  <!-- Bottom sheet for forecast -->
  <section id="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
    <div class="handle"></div>
    <div class="head">
      <div>
        <div id="sheetTitle" style="font-weight:700">Point Forecast</div>
        <div id="sheetSub" class="small"></div>
      </div>
      <button id="sheetClose" class="btn" aria-label="Close forecast">‚úï</button>
    </div>
    <div class="body">
      <ul id="sheetList" class="forecast-list"></ul>
    </div>
  </section>

  <!-- Floating Refresh -->
  <button id="fabRefresh" class="btn" title="Refresh data">üîÑ Refresh</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- Map init ---
    const CENTER = [36.95, -77.50];
    const map = L.map('map').setView(CENTER, 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

    // Header FIRMS button ‚Üí FIRMS map viewer at current center/zoom
    function openFirmsMap(){
      const c = map.getCenter(); const z = map.getZoom();
      const url = `https://firms.modaps.eosdis.nasa.gov/usfs/map/#d:today;l:fires_all,fire-perimeter,countries,earth;@${c.lng.toFixed(2)},${c.lat.toFixed(2)},${z.toFixed(2)}z`;
      window.open(url, '_blank');
    }
    document.getElementById('firmsBtn').addEventListener('click', (e)=>{ e.preventDefault(); openFirmsMap(); });

    // --- FIRMS layers (quick segmented control) ---
    const MAP_KEY = '01e7d5c7c7cd67df54a0e6f08c21e6ab';
    const firmsBase = () => `https://firms.modaps.eosdis.nasa.gov/mapserver/wms/fires/${MAP_KEY}/?`;
    const FIRMS = [
      { id:'viirs24', name:'VIIRS 24h', params:{ layers:'fires_viirs_24', format:'image/png', transparent:true, version:'1.1.1' }},
      { id:'modis24', name:'MODIS 24h', params:{ layers:'fires_modis_24', format:'image/png', transparent:true, version:'1.1.1' }},
      { id:'tsd', name:'Time Since', params:{ layers:'tsd_4_viirs_all', format:'image/png', transparent:true, version:'1.1.1' }},
    ];
    const layers = new Map();

    function addLayer(cfg){ return L.tileLayer.wms(firmsBase(), cfg.params); }
    function buildQuickLayers(){
      const bar = document.getElementById('quickLayers'); bar.innerHTML='';
      FIRMS.forEach(cfg=>{
        const b = document.createElement('button'); b.className='seg'; b.textContent=cfg.name;
        const lyr = addLayer(cfg); layers.set(cfg.id, lyr);
        b.onclick = ()=>{ if(map.hasLayer(lyr)){ map.removeLayer(lyr); b.classList.remove('active'); } else { lyr.addTo(map); b.classList.add('active'); } };
        bar.appendChild(b);
        if(cfg.id==='viirs24'){ lyr.addTo(map); b.classList.add('active'); }
      });
    }
    buildQuickLayers();

    // --- Alerts ---
    const alertsPanel = document.getElementById('alertsPanel');
    let alertsLayer = L.geoJSON(null, { style: { color: '#ef4444', weight: 2, opacity: 0.9, fillOpacity: 0.08 } }).addTo(map);
    async function loadVAAlerts(){
      try{ alertsPanel.innerHTML='<div class="small">Fetching alerts‚Ä¶</div>';
        const r = await fetch('https://api.weather.gov/alerts/active?area=VA'); const j = await r.json();
        alertsLayer.clearLayers(); let count=0; (j.features||[]).forEach(f=>{ if(f.geometry){ alertsLayer.addData(f); count++; } });
        alertsPanel.innerHTML = count? `<div class="small">Active alerts in VA: <strong>${count}</strong></div>` : '<div class="small">No active alerts.</div>';
      }catch{ alertsPanel.innerHTML='<div class="small">Alerts unavailable.</div>'; }
    }
    loadVAAlerts();

    // --- Data helpers ---
    function localTime(iso){ return new Date(iso).toLocaleString([], { hour: 'numeric' }); }
    async function getHourly(lat, lon){
      const p = await fetch(`https://api.weather.gov/points/${lat.toFixed(4)},${lon.toFixed(4)}`);
      const pj = await p.json(); const hourly = pj?.properties?.forecastHourly; const office = pj?.properties?.cwa;
      if(!hourly) throw new Error('No hourly'); const h = await fetch(hourly); const hj = await h.json();
      return { office, periods: (hj?.properties?.periods||[]) };
    }
    async function countHot(lat, lon){
      const d=0.25; const bbox = `${(lon-d).toFixed(3)},${(lat-d).toFixed(3)},${(lon+d).toFixed(3)},${(lat+d).toFixed(3)}`;
      const url = `https://firms.modaps.eosdis.nasa.gov/api/area/csv/${MAP_KEY}/VIIRS_SNPP_NRT,VIIRS_NOAA20_NRT/1/${bbox}`;
      try{ const r = await fetch(url); if(!r.ok) throw 0; const t = await r.text(); const Ls = t.trim().split(/\r?\n/); return (Ls.length>1)?(Ls.length-1):0; }catch{ return null; }
    }

    // --- Counties ---
    const COUNTY = [
      { id:'amelia', name:'Amelia',       lat:37.34, lon:-77.98 },
      { id:'nottoway', name:'Nottoway',   lat:37.14, lon:-78.05 },
      { id:'dinwiddie', name:'Dinwiddie', lat:37.08, lon:-77.66 },
      { id:'prgeorge', name:'Prince George', lat:37.20, lon:-77.22 },
      { id:'brunswick', name:'Brunswick', lat:36.77, lon:-77.87 },
      { id:'greensville', name:'Greensville', lat:36.68, lon:-77.56 }
    ];

    const chipRow = document.getElementById('chipRow');
    const overview = document.getElementById('overview');
    const countyData = new Map(); // id -> {temp, rh, wind, hotspots, periods, office}
    let activeChip = null;

    function updateChip(c){
      const el = document.getElementById(`met-${c.id}`);
      const dot = document.querySelector(`#chip-${c.id} .dot`);
      const d = countyData.get(c.id);
      if(!d) return;
      el.textContent = `${d.temp} ¬∑ RH ${d.rh}`;
      if(d.hotspots==null){ dot.style.background='#94a3b8'; dot.title='Hotspots n/a'; }
      else { dot.style.background = d.hotspots>0? '#ef4444' : '#22c55e'; dot.title = `Hotspots: ${d.hotspots}`; }
    }
    function updateCard(c){
      const d = countyData.get(c.id); if(!d) return;
      const t = document.getElementById(`ov-t-${c.id}`);
      const r = document.getElementById(`ov-r-${c.id}`);
      const w = document.getElementById(`ov-w-${c.id}`);
      const h = document.getElementById(`ov-h-${c.id}`);
      if(t) t.textContent = d.temp; if(r) r.textContent = d.rh; if(w) w.textContent = d.wind; if(h) h.textContent = (d.hotspots==null? 'n/a' : d.hotspots);
    }

    async function loadCounty(c){
      try{
        const [{ office, periods }, hotspots] = await Promise.all([ getHourly(c.lat, c.lon), countHot(c.lat, c.lon) ]);
        const now = periods[0] || {};
        const data = {
          office,
          periods,
          temp: (now.temperature!=null? `${now.temperature}¬∞${now.temperatureUnit}` : '‚Äì'),
          rh: (now.relativeHumidity?.value!=null? `${Math.round(now.relativeHumidity.value)}%` : '‚Äì'),
          wind: (now.windSpeed || '‚Äì'),
          hotspots
        };
        countyData.set(c.id, data);
        updateChip(c); updateCard(c);
      }catch{
        const data = { office:'', periods:[], temp:'‚Äì', rh:'‚Äì', wind:'‚Äì', hotspots:null };
        countyData.set(c.id, data); updateChip(c); updateCard(c);
      }
    }

    function buildChips(){
      chipRow.innerHTML='';
      COUNTY.forEach(c=>{
        const chip = document.createElement('button'); chip.className='chip'; chip.id = `chip-${c.id}`; chip.setAttribute('aria-pressed','false');
        chip.innerHTML = `<span class="dot"></span><span class="name">${c.name}</span><span class="met" id="met-${c.id}">Loading‚Ä¶</span>`;
        chip.onclick = ()=>selectCounty(c, chip);
        chipRow.appendChild(chip);
      });
    }

    function buildOverview(){
      overview.innerHTML='';
      COUNTY.forEach(c=>{
        const card = document.createElement('div'); card.className='ov-card'; card.id = `ov-${c.id}`; card.setAttribute('role','button'); card.setAttribute('tabindex','0');
        card.innerHTML = `
          <div class="ov-title"><span>${c.name} County</span><span class="small">Hotspots: <strong id="ov-h-${c.id}">‚Ä¶</strong></span></div>
          <div class="ov-kpis">
            <div class="ov-kpi"><span class="lbl">Temp</span><span id="ov-t-${c.id}">‚Ä¶</span></div>
            <div class="ov-kpi"><span class="lbl">RH</span><span id="ov-r-${c.id}">‚Ä¶</span></div>
            <div class="ov-kpi"><span class="lbl">Wind</span><span id="ov-w-${c.id}">‚Ä¶</span></div>
            <div class="ov-kpi"><span class="lbl">Office</span><span id="ov-o-${c.id}">‚Äì</span></div>
          </div>`;
        card.addEventListener('click', ()=> openCountyForecast(c));
        card.addEventListener('keypress', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); openCountyForecast(c); } });
        overview.appendChild(card);
      });
    }

    async function openCountyForecast(c){
      map.setView([c.lat, c.lon], 10);
      openSheet('Loading‚Ä¶', `${c.name} County`);
      try{
        const d = countyData.get(c.id);
        if(d && d.periods && d.periods.length){ renderSheet(d.periods, `${c.name} County`, d.office); }
        else { const { office, periods } = await getHourly(c.lat, c.lon); countyData.set(c.id, { ...(countyData.get(c.id)||{}), office, periods }); renderSheet(periods, `${c.name} County`, office); }
      }catch{ openSheet('Forecast unavailable', `${c.name} County`); }
    }

    async function selectCounty(c, chipEl){
      if(activeChip) { activeChip.classList.remove('active'); activeChip.setAttribute('aria-pressed','false'); }
      activeChip = chipEl; activeChip.classList.add('active'); activeChip.setAttribute('aria-pressed','true');
      openCountyForecast(c);
    }

    function renderSheet(periods, title, office){
      document.getElementById('sheetTitle').textContent = title || 'Point Forecast';
      document.getElementById('sheetSub').textContent = office? `Office ${office}` : '';
      const list = document.getElementById('sheetList');
      list.innerHTML = (periods||[]).slice(0, 12).map(p=>`<li class="forecast-item"><span>${localTime(p.startTime)}</span><span>${p.temperature}¬∞${p.temperatureUnit}</span><span>RH ${p.relativeHumidity?.value??'‚Äì'}%</span><span>${p.windSpeed}</span></li>`).join('');
      sheet.classList.add('open');
    }

    function openSheet(text, title){
      document.getElementById('sheetTitle').textContent = title||'Point Forecast';
      document.getElementById('sheetSub').textContent = '';
      const list = document.getElementById('sheetList'); list.innerHTML = `<li class="forecast-item"><span class="small">${text}</span></li>`;
      sheet.classList.add('open');
    }

    const sheet = document.getElementById('sheet');
    document.getElementById('sheetClose').onclick = ()=> sheet.classList.remove('open');

    // Map click also opens sheet for that point
    map.on('click', async (e)=>{
      openSheet('Loading‚Ä¶','Map Point');
      try{ const { office, periods } = await getHourly(e.latlng.lat, e.latlng.lng); renderSheet(periods,'Map Point',office); }catch{ openSheet('Forecast unavailable','Map Point'); }
    });

    // Build UI + load data
    buildChips();
    buildOverview();
    COUNTY.forEach(c=> loadCounty(c));

    // Refresh
    function refreshAll(){ loadVAAlerts(); COUNTY.forEach(c=> loadCounty(c)); const z=map.getZoom(); map.setZoom(z); }
    document.getElementById('fabRefresh').onclick = refreshAll;

    // Visual focus bounds (cue)
    const focusBounds = L.latLngBounds([[36.6, -78.0], [37.5, -77.0]]);
    L.rectangle(focusBounds, { color:'#0ea5e9', weight:1, fillOpacity:0.03 }).addTo(map);
  </script>
</body>
</html>
