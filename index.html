<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ðŸ”¥ VA Fire Weather â€” Six Counties</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    :root{
      --bg:#f8fafc;
      --ink:#0f172a;
      --card:#ffffff;
      --border:#e2e8f0;
      --brand:#2563eb;
      --muted:#64748b;
      --shadow:0 6px 20px rgba(2,8,23,.06);
      --rad:14px;
    }
    [data-theme="dark"]{
      --bg:#0b1220;
      --ink:#e5e7eb;
      --card:#111827;
      --border:#374151;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:System-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial,sans-serif}
    header{background:var(--brand);color:#fff;padding:.8rem 1rem;display:flex;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:1.1rem}
    .menu{display:flex;gap:.5rem}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.25);background:#fff;color:#0f172a;padding:.4rem .6rem;border-radius:8px;cursor:pointer;font-size:.9rem}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    main{max-width:1200px;margin:0 auto;padding:1rem;display:grid;gap:1rem}
    .meta{font-size:.85rem;color:var(--muted);text-align:right}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--rad);box-shadow:var(--shadow)}
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:.95rem}
    thead th{background:var(--brand);color:#fff;text-align:left;padding:.75rem}
    tbody td{padding:.65rem .75rem;border-bottom:1px solid var(--border)}
    td.num{text-align:right;font-variant-numeric:tabular-nums}
    .hint{font-size:.8rem;color:var(--muted)}
    .banner{display:none;background:#fff7ed;color:#7c2d12;border:1px solid #fed7aa;padding:.6rem .75rem;border-radius:10px}
    .map-wrap{height:420px;border-radius:var(--rad);overflow:hidden;border:1px solid var(--border)}
    .cards{display:grid;gap:.75rem;grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
    .mini-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:.75rem;box-shadow:var(--shadow)}
    .mini-card h3{margin:.1rem 0 .4rem 0;font-size:.95rem}
    .mini-grid{display:grid;grid-template-columns:1fr 1fr;gap:.25rem .75rem;font-size:.9rem}
    footer{color:var(--muted);text-align:center;padding:1rem;font-size:.9rem}
    @media (max-width:640px){
      main{padding:.75rem}
      header{padding:.6rem .8rem}
      h1{font-size:1rem}
      .map-wrap{height:360px}
    }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ”¥ VA Fire Weather â€” Amelia Â· Nottoway Â· Brunswick Â· Dinwiddie Â· Greensville Â· Prince George</h1>
    <nav class="menu">
      <button id="themeBtn" class="btn" type="button">ðŸŒ“ Night</button>
      <button id="refreshBtn" class="btn" type="button">ðŸ”„ Refresh</button>
      <a class="btn" href="https://www.weather.gov/akq/" target="_blank" rel="noopener">NWS AKQ</a>
    </nav>
  </header>

  <main>
    <div id="updated" class="meta">Last updated: â€”</div>
    <div id="banner" class="banner">Partial data: one or more sources failed. Displaying what we could fetch.</div>

    <!-- Counties Card -->
    <section class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:.5rem;flex-wrap:wrap;padding:.5rem 1rem 0 1rem">
        <h2 style="margin:.25rem 0;font-size:1rem;color:var(--ink)">Counties</h2>
        <div class="hint">Tap a hotspot on the map for FIRMS</div>
      </div>
      <div id="countyCards" class="cards" style="padding:.75rem"></div>
    </section>

    <!-- County metrics Table -->
    <section class="card table-wrap">
      <table>
        <thead>
          <tr>
            <th>County</th>
            <th class="num">Temp (Â°F)</th>
            <th class="num">R.H. (%)</th>
            <th class="num">Dew Pt (Â°F)</th>
            <th class="num">Wind (mph)</th>
            <th>Dir</th>
            <th class="num">Hotspots (24h)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <p class="hint">Hourly NOAA/NWS forecast points per county center; dew point derived from temp + RH. Hotspots counted within ~25 km of each county center using NASA FIRMS 24-hour feed.</p>
    </section>

    <!-- FIRMS Map -->
    <section class="map-wrap">
      <div id="map"></div>
    </section>
  </main>

  <footer>Data: NOAA/NWS & NASA FIRMS â€¢ Auto-refreshes hourly â€¢ Map stays bright in night mode</footer>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  <script>
    const COUNTIES = [
      { name:"Amelia",lat:37.342,lon:-77.980 },
      { name:"Nottoway",lat:37.142,lon:-78.089 },
      { name:"Brunswick",lat:36.758,lon:-77.847 },
      { name:"Dinwiddie",lat:37.077,lon:-77.587 },
      { name:"Greensville",lat:36.686,lon:-77.542 },
      { name:"Prince George",lat:37.221,lon:-77.288 }
    ];
    const FIRMS_URL="https://firms.modaps.eosdis.nasa.gov/active_fire/c6.1/geojson/MODIS_C6_1_USA_contiguous_and_Hawaii_24h.geojson";
    const BBOX=[-78.5,36.4,-77.0,37.7];
    let map,firmsLayer,inFlight=false;

    const qs=(s,p=document)=>p.querySelector(s);
    const fmtTime=(d=new Date())=>d.toLocaleString(undefined,{hour12:true});
    const dewPointF=(t,rh)=>{if(!Number.isFinite(t)||!Number.isFinite(rh))return null;const T=(t-32)*5/9,a=17.625,b=243.04,alpha=Math.log(Math.max(1e-6,rh/100))+(a*T)/(b+T);return Math.round(((b*alpha)/(a-alpha))*9/5+32)};
    const mphFromWindStr=str=>{if(!str)return null;const n=(str.match(/\\d+/g)||[]).map(n=>parseInt(n,10));return n.length?Math.max(...n):null};
    function withTimeout(ms=20000){const c=new AbortController(),t=setTimeout(()=>c.abort(),ms);const exec=(i,o={})=>fetch(i,{...o,signal:c.signal}).finally(()=>clearTimeout(t));return{exec,abort:()=>c.abort()}}
    async function fetchJSON(url,o={},ms=20000){const ft=withTimeout(ms);const r=await ft.exec(url,o);if(!r.ok)throw new Error(r.status);return r.json()}

    async function getHourly(lat,lon){try{const m=await fetchJSON(`https://api.weather.gov/points/${lat},${lon}`);const h=m?.properties?.forecastHourly;if(!h)throw new Error("No hourly URL");const d=await fetchJSON(h);const p=d?.properties?.periods?.[0];if(!p)return null;return{tempF:+p.temperature||null,rh:+p?.relativeHumidity?.value||null,windStr:[p.windSpeed||"",p.windDirection||""].filter(Boolean).join(" "),windMph:mphFromWindStr(p.windSpeed)||mphFromWindStr(p.windGust),dir:p.windDirection||"â€”"}}catch(e){console.warn("NOAA error",e);return null}}
    async function getFirmsGeo(){try{const g=await fetchJSON(FIRMS_URL);g.features=g.features.filter(f=>{const[lon,lat]=f.geometry.coordinates;return lon>=BBOX[0]&&lon<=BBOX[2]&&lat>=BBOX[1]&&lat<=BBOX[3]});return g}catch(e){console.warn("FIRMS error",e);return{type:"FeatureCollection",features:[]}}}
    function countHotspotsByCounty(features,r=25){const m=new Map();for(const c of COUNTIES){const circle=turf.circle([c.lon,c.lat],r,{units:"kilometers"});m.set(c.name,features.filter(f=>turf.booleanPointInPolygon(turf.point(f.geometry.coordinates),circle)).length)}return m}
    function buildFirmsUrl(lat,lon,z=12){return`https://firms.modaps.eosdis.nasa.gov/map/#t:adv;d:24hrs;@${lat.toFixed(3)},${lon.toFixed(3)},${z}z`}

    function initMap(){map=L.map("map").setView([37.1,-77.6],8);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap"}).addTo(map)}
    function renderFirmsLayer(g){if(firmsLayer)map.removeLayer(firmsLayer);firmsLayer=L.geoJSON(g,{pointToLayer:(f,latlng)=>L.circleMarker(latlng,{radius:5,color:"#ef4444",fillColor:"#ef4444",fillOpacity:.9,weight:1}),onEachFeature:(f,l)=>{const[lon,lat]=f.geometry.coordinates;const url=buildFirmsUrl(lat,lon);l.bindPopup(`ðŸ”¥ Hotspot<br><a href=\"${url}\" target=\"_blank\">Open FIRMS â†’</a>`);l.on("click",()=>window.open(url,"_blank"))}}).addTo(map)}

    function renderTable(rows,counts){const tb=qs("#tbody");const frag=document.createDocumentFragment();COUNTIES.forEach((c,i)=>{const wx=rows[i];const temp=wx?.tempF,rh=wx?.rh,dp=dewPointF(temp,rh),wind=wx?.windMph,dir=wx?.dir||"â€”";const tr=document.createElement("tr");const td=(v,cl="")=>{const e=document.createElement("td");if(cl)e.className=cl;e.textContent=v;return e};tr.append(td(c.name),td(Number.isFinite(temp)?Math.round(temp):"â€”","num"),td(Number.isFinite(rh)?Math.round(rh):"â€”","num"),td(Number.isFinite(dp)?Math.round(dp):"â€”","num"),td(Number.isFinite(wind)?Math.round(wind):"â€”","num"),td(dir),td(String(counts.get(c.name)||0),"num"));frag.appendChild(tr)});tb.replaceChildren(frag)}
    function renderCountyCards(rows,counts){const wrap=qs("#countyCards");const frag=document.createDocumentFragment();COUNTIES.forEach((c,i)=>{const wx=rows[i]||{};const temp=Number.isFinite(wx.tempF)?Math.round(wx.tempF):"â€”";const rh=Number.isFinite(wx.rh)?Math.round(wx.rh):"â€”";const dp=dewPointF(wx.tempF,wx.rh);const dpTxt=Number.isFinite(dp)?dp:"â€”";const wind=Number.isFinite(wx.windMph)?Math.round(wx.windMph):"â€”";const dir=wx.dir||"â€”";const hot=counts.get(c.name)||0;const card=document.createElement("div");card.className="mini-card";card.innerHTML=`<h3>${c.name}</h3><div class=\"mini-grid\"><div>Temp</div><div style=\"text-align:right\">${temp}Â°F</div><div>RH</div><div style=\"text-align:right\">${rh}%</div><div>Dew Pt</div><div style=\"text-align:right\">${dpTxt}Â°F</div><div>Wind</div><div style=\"text-align:right\">${wind} mph ${dir}</div><div>Hotspots</div><div style=\"text-align:right\">${hot}</div></div>`;frag.appendChild(card)});wrap.replaceChildren(frag)}

    function initTheme(){const saved=localStorage.getItem("ffwx:theme");if(saved==="dark")document.documentElement.dataset.theme="dark";qs("#themeBtn").addEventListener("click",()=>{const dark=document.documentElement.dataset.theme==="dark";if(dark){document.documentElement.removeAttribute("data-theme");localStorage.setItem("ffwx:theme","")}else{document.documentElement.dataset.theme="dark";localStorage.setItem("ffwx:theme","dark")}})}

    async function refreshAll(){if(inFlight)return;inFlight=true;qs("#updated").textContent=`Last updated: ${fmtTime()}`;qs("#banner").style.display="none";try{const[geo,res]=await Promise.all([getFirmsGeo(),Promise.allSettled(COUNTIES.map(c=>getHourly(c.lat,c.lon)))]);const rows=res.map(r=>r.status==="fulfilled"?r.value:null);const counts=countHotspotsByCounty(geo.features);renderFirmsLayer(geo);renderCountyCards(rows,counts);renderTable(rows,counts);if(rows.some(r=>r===null))qs("#banner").style.display="block"}catch(e){qs("#banner").style.display="block"}finally{inFlight=false}}

    window.addEventListener("DOMContentLoaded",()=>{initTheme();qs("#refreshBtn").addEventListener("click",refreshAll);initMap();refreshAll();setInterval(refreshAll,3600000)});
  </script>
</body>
</html>
