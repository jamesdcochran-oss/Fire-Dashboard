<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üî• Five Forks Fire Weather</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

  <!-- Turf -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js" defer></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js" defer></script>

  <style>
    :root { --bg:#0f172a; --text:#e5e7eb; --card:#111827; --border:#334155; --brand:#3b82f6; --muted:#9ca3af }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{background:var(--brand);color:#fff;padding:.75rem 1rem;display:flex;justify-content:space-between;align-items:center;gap:.5rem;flex-wrap:wrap}
    h1{margin:0;font-size:1.05rem}
    .menu{display:flex;gap:.5rem;flex-wrap:wrap}
    .btn,.menu a,select.btn{background:#fff;color:#111;border:1px solid #e5e7eb;padding:.35rem .6rem;border-radius:9999px;text-decoration:none;font-size:.85rem;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:progress}
    main{display:grid;gap:1rem;padding:1rem}
    .cards{display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:.9rem;box-shadow:0 1px 4px rgba(0,0,0,.25)}
    .meta{font-size:.8rem;color:var(--muted);text-align:right}
    .map-wrap{height:520px;border-radius:14px;overflow:hidden;border:1px solid var(--border)}
    footer{color:var(--muted);text-align:center;padding:1rem}
    .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .5rem;border-radius:9999px;border:1px solid var(--border);background:#fff;color:#111;font-size:.75rem}
    .ok{color:#10b981;border-color:#10b981}.warn{color:#f59e0b;border-color:#f59e0b}.err{color:#ef4444;border-color:#ef4444}
    .flags{display:flex;gap:.35rem;flex-wrap:wrap;margin-top:.35rem}
    .flag{font-weight:700;font-size:.8rem}
    .flash{color:#ef4444;animation:flash 1s steps(2,end) infinite}
    @keyframes flash{50%{opacity:.2}}
    .legend{font-size:.8rem;color:var(--muted)}
    .legend code{background:#0b1225;border:1px solid var(--border);border-radius:6px;padding:.1rem .3rem;color:#e5e7eb}
    details summary{cursor:pointer}
    .leaflet-container{height:100%;width:100%}
    pre.diag{white-space:pre-wrap;margin:0;font-size:.8rem;color:#e5e7eb}
    /* Fire-themed clusters */
    .marker-cluster-small { background: rgba(239,68,68,0.8); }
    .marker-cluster-medium { background: rgba(249,115,22,0.8); }
    .marker-cluster-large { background: rgba(202,138,4,0.8); }
    .marker-cluster div { color: #fff; font-weight: bold; text-shadow: 0 0 2px black; }
  </style>
</head>
<body>
  <header>
    <h1>üî• Five Forks Fire Weather</h1>
    <nav class="menu" aria-label="Primary">
      <button id="unitBtn" class="btn" title="Toggle ¬∞F/¬∞C">¬∞F</button>
      <button id="refreshBtn" class="btn" title="Refresh">üîÑ Refresh</button>
      <label for="radiusSel" class="btn" title="Hotspot radius (km)" style="display:inline-flex;gap:.4rem;align-items:center">
        Radius
        <select id="radiusSel" class="btn" style="margin-left:.25rem">
          <option value="20">20 km</option>
          <option value="30">30 km</option>
          <option value="40">40 km</option>
        </select>
      </label>
      <span id="statusPill" class="pill" aria-live="assertive">‚Äî</span>
    </nav>
  </header>

  <main>
    <div class="legend">
      <details>
        <summary>‚ÑπÔ∏è Fire weather rules used here</summary>
        <div style="margin-top:.4rem">
          <div><strong>30/30/30 rule</strong>: <code>T ‚â• 30¬∞C (86¬∞F)</code>, <code>RH ‚â§ 30%</code>, <code>Wind ‚â• 30 km/h (~18 mph)</code>. <em>(blinks)</em></div>
          <div>We flag <strong>NEAR</strong> 30/30/30 if within ~10% (or ‚â•2 of 3 near).</div>
        </div>
      </details>
    </div>

    <div id="updated" class="meta">Last updated: ‚Äî</div>
    <section id="cards" class="cards" aria-live="polite" aria-busy="false"></section>
    <section class="map-wrap"><div id="map"></div></section>
  </main>

  <footer>Data: NOAA & NASA FIRMS ‚Ä¢ Updates hourly</footer>

  <script>
    const APP_VERSION = '1.9.0';
    document.title = `üî• Five Forks Fire Weather ¬∑ ${APP_VERSION}`;

    const COUNTIES = [
      { name: "Amelia", lat: 37.342, lon: -77.980 },
      { name: "Nottoway", lat: 37.142, lon: -78.089 },
      { name: "Dinwiddie", lat: 37.077, lon: -77.587 },
      { name: "Prince George", lat: 37.221, lon: -77.288 },
      { name: "Brunswick", lat: 36.758, lon: -77.847 },
      { name: "Greensville", lat: 36.686, lon: -77.542 }
    ];

    const FIRMS_SOURCES = [
      'https://firms.modaps.eosdis.nasa.gov/active_fire/viirs/geojson/VIIRS_I_NRT_USA_contiguous_and_Hawaii_24h.geojson',
      'https://firms.modaps.eosdis.nasa.gov/active_fire/c6.1/geojson/MODIS_C6_1_USA_contiguous_and_Hawaii_24h.geojson'
    ];
    const ESRI_VIIRS = 'https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Satellite_VIIRS_Thermal_Hotspots_and_Fire_Activity/FeatureServer/0/query';
    const ESRI_MODIS = 'https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Satellite_MODIS_Thermal_Hotspots_and_Fire_Activity/FeatureServer/0/query';

    let unit = localStorage.getItem('ff:unit') || 'F';
    let radiusKm = parseInt(localStorage.getItem('ff:radius') || '30', 10);
    let lastSuccessAt = 0;
    let currentCtrl = null;
    const hourlyUrlCache = new Map();
    let lastWxResults = [];

    const $ = s => document.querySelector(s);
    const toC = f => Math.round(((f-32)*5)/9);
    function setStatus(text, cls){
      const pill = $('#statusPill');
      pill.className = 'pill ' + (cls||'');
      pill.textContent = text;
    }

    async function fetchJSON(url, opts={}) {
      const res = await fetch(url, { ...opts, cache:'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status} ${url}`);
      return res.json();
    }

    async function fetchWithRetry(url, opts={}, attempts=3, delay=1000){
      for(let i=0;i<attempts;i++){
        try{ return await fetchJSON(url, opts); }
        catch(err){ if(i===attempts-1) throw err; await new Promise(r=>setTimeout(r, delay*(i+1))); }
      }
    }

    function parseWindMph(s){ const nums=(s||'').match(/\d+/g)||[]; return nums.length?Math.max(...nums.map(n=>+n)):null; }
    function flags303030(tempF, rh, windStr){
      const tempC=tempF!=null?(tempF-32)*5/9:null; const windMph=parseWindMph(windStr);
      const within=(tempC>=30&&rh<=30&&windMph>=18); 
      const near=!within && ( (tempC>=28?1:0)+(rh<=33?1:0)+(windMph>=16?1:0) )>=2;
      return {within,near};
    }

    async function fetchWeather(lat, lon, signal){
      try{
        const key=`${lat.toFixed(3)},${lon.toFixed(3)}`;
        let hourlyUrl=hourlyUrlCache.get(key);
        if(!hourlyUrl){
          const meta=await fetchWithRetry(`https://api.weather.gov/points/${lat},${lon}`,{
            signal,headers:{'Accept':'application/geo+json','User-Agent':'FiveForksFireWeather (https://yourdomain.com)'}
          });
          hourlyUrl=meta?.properties?.forecastHourly; if(hourlyUrl) hourlyUrlCache.set(key,hourlyUrl);
        }
        if(!hourlyUrl) return null;
        const data=await fetchWithRetry(hourlyUrl,{signal,headers:{'Accept':'application/geo+json','User-Agent':'FiveForksFireWeather (https://yourdomain.com)'}});
        const p=data?.properties?.periods?.[0]; if(!p) return null;
        return {tempF:p.temperature??null, rh:p.relativeHumidity?.value??null, dpC:p.dewpoint?.value??null, wind:[p.windSpeed||'',p.windDirection||''].filter(Boolean).join(' '), short:p.shortForecast||'‚Äî'};
      }catch(e){console.warn('NOAA error',e);return null;}
    }

    async function fetchAllFirms(signal){
      try{
        const results=await Promise.allSettled(FIRMS_SOURCES.map(u=>fetchWithRetry(u,{signal})));
        const collections=results.filter(r=>r.status==='fulfilled').map(r=>r.value);
        const seen=new Set(),out=[];
        for(const col of collections){ for(const f of col.features||[]){ if(f.geometry?.type==='Point'){ const[x,y]=f.geometry.coordinates; if(Number.isFinite(x)&&Number.isFinite(y)){ const k=`${x.toFixed(3)},${y.toFixed(3)}`; if(!seen.has(k)){seen.add(k);out.push(f);} }}}}
        if(out.length) return {type:'FeatureCollection',features:out};
      }catch(e){console.warn('NASA FIRMS failed',e);}
      try{
        const params=new URLSearchParams({geometry:'-79,35,-76,39',geometryType:'esriGeometryEnvelope',inSR:'4326',outFields:'*',outSR:'4326',f:'geojson'});
        const v=await fetchWithRetry(`${ESRI_VIIRS}?${params}`,{signal}); return v;
      }catch(e){console.warn('Esri fallback failed',e);return{type:'FeatureCollection',features:[]};}
    }

    function renderCard(name, wx, hotspots){
      const tempF=wx?.tempF??null; const tempText=tempF!=null?(unit==='C'?toC(tempF)+'¬∞C':Math.round(tempF)+'¬∞F'):'‚Äî';
      const tempC=tempF!=null?(tempF-32)*5/9:null;
      let rh=wx?.rh, rhEst=false; if(rh==null&&wx?.dpC!=null&&tempC!=null){ rh=100*(6.112*Math.exp((17.625*wx.dpC)/(243.04+wx.dpC)))/(6.112*Math.exp((17.625*tempC)/(243.04+tempC))); rhEst=true; }
      rh=rh!=null?Math.max(1,Math.min(100,Math.round(rh))):null;
      const rhText=rh!=null?`${rh}% RH${rhEst?' (est)':''}`:'‚Äî% RH';
      const dp=wx?.dpC, dpText=dp!=null?(unit==='C'?Math.round(dp)+'¬∞C':Math.round(dp*9/5+32)+'¬∞F'):'‚Äî';
      const f3030=wx?flags303030(tempF,rh,wx.wind):{within:false,near:false};
      const flagsEl=document.createElement('div');flagsEl.className='flags';
      if(f3030.within)flagsEl.appendChild(el('span',{class:'flag flash',text:'30/30/30'}));
      else if(f3030.near)flagsEl.appendChild(el('span',{class:'flag flash',text:'NEAR 30/30/30'}));
      return el('div',{class:'card'},
        el('strong',{text:name}),el('br'),
        el('span',{text:`${tempText} ¬∑ ${rhText} ¬∑ DP ${dpText}${wx?.wind?' ¬∑ '+wx.wind:''}`}),el('br'),
        el('span',{text:(wx?wx.short:'Weather unavailable')+(Number.isFinite(hotspots)?` ¬∑ üî• ${hotspots}`:'')}),
        flagsEl
      );
    }
    function el(tag,attrs={},...children){const n=document.createElement(tag);for(const[k,v]of Object.entries(attrs))k==='class'?n.className=v:k==='text'?n.textContent=v:n.setAttribute(k,v);for(const c of children)typeof c==='string'?n.appendChild(document.createTextNode(c)):c&&n.appendChild(c);return n;}

    let map,firmsCluster,centersLayer,fitted=false;
    function ensureMap(firms){
      if(!map){
        map=L.map('map').setView([37.1,-77.5],8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
        firmsCluster=L.markerClusterGroup(); centersLayer=L.layerGroup().addTo(map);
        map.addLayer(firmsCluster);
        L.control.layers({},{"üî• Hotspots":firmsCluster,"üìç County centers":centersLayer},{collapsed:true}).addTo(map);
      }
      firmsCluster.clearLayers(); centersLayer.clearLayers();
      firms.features.forEach(f=>{if(f.geometry?.type==='Point'){const[lon,lat]=f.geometry.coordinates; if(!Number.isFinite(lat)||!Number.isFinite(lon))return;
        const conf=(f?.properties?.confidence||'').toLowerCase(); let color='#ffa500'; if(conf.includes('low'))color='#facc15'; else if(conf.includes('high'))color='#ef4444';
        const radius=Math.min(12,Math.max(4,(f?.properties?.brightness||300)/100));
        const meta=`Conf: ${f?.properties?.confidence||'n/a'} ¬∑ Brightness: ${f?.properties?.brightness||'n/a'} ¬∑ Date: ${f?.properties?.acq_date||'n/a'}`;
        const firmsUrl=`https://firms.modaps.eosdis.nasa.gov/map/#d:24hrs;@${lon.toFixed(4)},${lat.toFixed(4)},12z`;
        const gmapsUrl=`https://www.google.com/maps?q=${lat.toFixed(5)},${lon.toFixed(5)}`;
        const html=`üî• Fire detected<br>${meta}<br><a href="${firmsUrl}" target="_blank">FIRMS</a> ¬∑ <a href="${gmapsUrl}" target="_blank">Google Maps</a>`;
        firmsCluster.addLayer(L.circleMarker([lat,lon],{radius,fillColor:color,color,weight:1,opacity:1,fillOpacity:0.8}).
