<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ”¥ Five Forks Fire Weather</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

  <!-- Turf -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js" defer></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js" defer></script>

  <style>
    body { margin:0; font-family: system-ui, sans-serif; background:#0f172a; color:#e5e7eb; }
    header { background:#3b82f6; color:#fff; padding:.75rem 1rem; display:flex; justify-content:space-between; flex-wrap:wrap; align-items:center; gap:.5rem; }
    h1 { margin:0; font-size:1rem; }
    nav a, .btn { background:#fff; border:1px solid #ccc; border-radius:9999px; padding:.3rem .6rem; cursor:pointer; text-decoration:none; font-size:.85rem; color:#111; }
    main { display:grid; gap:1rem; padding:1rem; }
    .cards { display:grid; gap:1rem; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); }
    .card { background:#111827; border:1px solid #334155; border-radius:14px; padding:.9rem; }
    .meta { font-size:.8rem; color:#9ca3af; text-align:right; }
    .map-wrap { height:520px; border-radius:14px; overflow:hidden; border:1px solid #334155; }
    .pill { display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .5rem; border-radius:9999px; background:#fff; color:#111; font-size:.75rem; }
    .ok { color:#10b981; }
    .warn { color:#f59e0b; }
    .err { color:#ef4444; }
    .flags { margin-top:.4rem; font-size:.8rem; font-weight:700; color:#ef4444; }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ”¥ Five Forks Fire Weather</h1>
    <nav style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:center">
      <button id="unitBtn" class="btn">Â°F</button>
      <button id="refreshBtn" class="btn">ğŸ”„ Refresh</button>
      <span id="statusPill" class="pill">â€”</span>
      <a href="https://www.weather.gov/akq/" target="_blank" rel="noopener">AKQ</a>
      <a href="https://www.weather.gov/akq/FIREMAIN" target="_blank" rel="noopener">AKQ Fire</a>
      <a href="https://fs-prod-nwcg.s3.us-gov-west-1.amazonaws.com/s3fs-public/publication/pms461.pdf" target="_blank" rel="noopener">IRPG</a>
    </nav>
  </header>

  <main>
    <div id="updated" class="meta">Last updated: â€”</div>
    <section id="cards" class="cards"></section>
    <section class="map-wrap"><div id="map"></div></section>
  </main>

  <footer style="text-align:center; color:#9ca3af; padding:1rem">
    Data: NOAA &amp; FIRMS (Esri) â€¢ Updates hourly
  </footer>

<script>
const COUNTIES = [
  { name: "Amelia",        lat: 37.342, lon: -77.980 },
  { name: "Nottoway",      lat: 37.142, lon: -78.089 },
  { name: "Dinwiddie",     lat: 37.077, lon: -77.587 },
  { name: "Prince George", lat: 37.221, lon: -77.288 },
  { name: "Brunswick",     lat: 36.758, lon: -77.847 },
  { name: "Greensville",   lat: 36.686, lon: -77.542 }
];

// Bounding box for Five Forks area
const bbox = [-78.8,36.4,-77.0,37.6];

// Esri FIRMS endpoints (CORS-safe)
const ESRI_VIIRS = "https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Satellite_VIIRS_Thermal_Hotspots_and_Fire_Activity/FeatureServer/0/query";
const ESRI_MODIS = "https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Satellite_MODIS_Thermal_Hotspots_and_Fire_Activity/FeatureServer/0/query";

let unit = "F";
const $ = s => document.querySelector(s);

// ---- Helpers ----
function toC(f) { return Math.round((f-32)*5/9); }
function parseWindMph(s){ const nums=(s||"").match(/\d+/g)||[]; return nums.length?Math.max(...nums.map(n=>+n)):null; }
function flags303030(tempF, rh, windStr){
  const tempC=(tempF-32)*5/9; const windMph=parseWindMph(windStr);
  const within=(tempC>=30&&rh<=30&&windMph>=18);
  const near=!within && ( (tempC>=28?1:0)+(rh<=33?1:0)+(windMph>=16?1:0) )>=2;
  return {within,near};
}

// ---- NOAA Weather ----
const urlCache = JSON.parse(localStorage.getItem("ff:wxurls")||"{}");

async function fetchWeather(lat, lon, name){
  try{
    let hourly = urlCache[name];
    if(!hourly){
      const meta=await fetch(`https://api.weather.gov/points/${lat},${lon}`,{headers:{Accept:"application/geo+json"}});
      const m=await meta.json();
      hourly=m.properties.forecastHourly;
      urlCache[name]=hourly;
      localStorage.setItem("ff:wxurls",JSON.stringify(urlCache));
    }
    const data=await fetch(hourly,{headers:{Accept:"application/geo+json"}});
    const j=await data.json();
    const p=j.properties.periods[0];
    return {
      tempF:p.temperature,
      rh:p.relativeHumidity?.value,
      dpC:p.dewpoint?.value,
      wind:`${p.windSpeed} ${p.windDirection}`,
      short:p.shortForecast
    };
  }catch(e){console.warn("NOAA fail",name,e);return null;}
}

// ---- FIRMS (Esri) ----
async function fetchFirms(){
  const [xmin,ymin,xmax,ymax] = bbox;
  const common = {
    geometry: `${xmin},${ymin},${xmax},${ymax}`,
    geometryType: "esriGeometryEnvelope",
    inSR: "4326",
    spatialRel: "esriSpatialRelIntersects",
    outFields: "*",
    outSR: "4326",
    f: "geojson"
  };
  const viirsParams = new URLSearchParams({ ...common, where: "acq_date >= CURRENT_DATE - 1" });
  const modisParams = new URLSearchParams({ ...common, where: "acq_date >= CURRENT_DATE - 2" });
  const urls = [`${ESRI_VIIRS}?${viirsParams}`, `${ESRI_MODIS}?${modisParams}`];

  const out = [], seen=new Set();
  for(const url of urls){
    try{
      const res=await fetch(url);
      const j=await res.json();
      for(const f of j.features||[]){
        if(f.geometry?.type==="Point"){
          const [x,y]=f.geometry.coordinates;
          const key=`${x.toFixed(3)},${y.toFixed(3)}`;
          if(!seen.has(key)){ seen.add(key); out.push(f); }
        }
      }
    }catch(e){console.warn("FIRMS fail",e);}
  }
  return { type:"FeatureCollection", features: out };
}

// ---- UI ----
function renderCard(name,wx,hotspots){
  const tempF=wx?.tempF??null;
  const tempText=tempF?(unit==="C"?toC(tempF)+"Â°C":Math.round(tempF)+"Â°F"):"â€”";
  const rh=wx?.rh!=null?Math.round(wx.rh):null;
  const rhText=rh!=null?`${rh}% RH`:"â€”% RH";
  const dp=wx?.dpC!=null?(unit==="C"?Math.round(wx.dpC)+"Â°C":Math.round(wx.dpC*9/5+32)+"Â°F"):"â€”";
  const f3030=wx?flags303030(tempF,rh,wx.wind):{within:false,near:false};
  const flags=f3030.within?"ğŸ”¥ 30/30/30":f3030.near?"âš ï¸ Near 30/30/30":"";
  return `<div class="card"><strong>${name}</strong><br>${tempText} Â· ${rhText} Â· DP ${dp} Â· ${wx?.wind||"â€”"}<br>${wx?.short||"Weather unavailable"} Â· ğŸ”¥ ${hotspots}<div class="flags">${flags}</div></div>`;
}

// ---- Map ----
let map,firmsCluster,centersLayer;
function ensureMap(firms){
  if(!map){
    map=L.map("map");
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      {attribution:"Â© OpenStreetMap"}).addTo(map);
    firmsCluster=L.markerClusterGroup();
    centersLayer=L.layerGroup();
    map.addLayer(firmsCluster);
    map.addLayer(centersLayer);

    // Fit to county bounds
    const latlngs = COUNTIES.map(c => [c.lat, c.lon]);
    const bounds = L.latLngBounds(latlngs);
    map.fitBounds(bounds.pad(0.3));
  }

  // Clear and redraw
  firmsCluster.clearLayers();
  centersLayer.clearLayers();

  // Add hotspots
  L.geoJSON(firms,{pointToLayer:(f,latlng)=>{
    const [lon,lat]=f.geometry.coordinates;
    const firmsUrl=`https://firms.modaps.eosdis.nasa.gov/map/#d:24hrs;@${lon.toFixed(4)},${lat.toFixed(4)},12z`;
    const gmapsUrl=`https://www.google.com/maps?q=${lat.toFixed(5)},${lon.toFixed(5)}`;
    return L.circleMarker(latlng,{
      radius:6,fillColor:"#ef4444",color:"#ef4444",weight:1,opacity:1,fillOpacity:.8
    }).bindPopup(`ğŸ”¥ Fire detected<br>
      <a href="${firmsUrl}" target="_blank">FIRMS Map</a> Â· 
      <a href="${gmapsUrl}" target="_blank">Google Maps</a>`);
  }}).addTo(firmsCluster);

  // Add county centers
  COUNTIES.forEach(c=>{
    L.circleMarker([c.lat,c.lon],{
      radius:6,color:"#2563eb",fillColor:"#3b82f6",fillOpacity:0.6,weight:2
    }).bindPopup(`<strong>${c.name} County</strong>`).addTo(centersLayer);
  });
}

// ---- Refresh ----
async function refresh(){
  $("#statusPill").textContent="Loadingâ€¦"; $("#refreshBtn").disabled=true;
  try{
    const [firms,wx]=await Promise.all([
      fetchFirms(),
      Promise.all(COUNTIES.map(c=>fetchWeather(c.lat,c.lon,c.name)))
    ]);
    let frag=""; COUNTIES.forEach((c,i)=>{
      const hs=turf.pointsWithinPolygon(
        turf.points(firms.features.map(f=>f.geometry.coordinates)),
        turf.circle([c.lon,c.lat],30,{units:"kilometers"})
      ).features.length;
      frag+=renderCard(c.name,wx[i],hs);
    });
    $("#cards").innerHTML=frag;
    ensureMap(firms);
    $("#updated").textContent="Last updated: "+new Date().toLocaleString();
    if(!firms.features.length && wx.every(w=>!w)) $("#statusPill").textContent="Error";
    else if(wx.some(w=>!w)) $("#statusPill").textContent="Partial";
    else $("#statusPill").textContent="Fresh";
  }catch(e){
    console.warn("Refresh fail",e);
    $("#statusPill").textContent="Error";
  }finally{
    $("#refreshBtn").disabled=false;
  }
}

$("#unitBtn").addEventListener("click",()=>{unit=(unit==="F"?"C":"F");$("#unitBtn").textContent="Â°"+unit;refresh();});
$("#refreshBtn").addEventListener("click",refresh);
refresh();
setInterval(refresh,60*60*1000);
</script>
</body>
</html>
