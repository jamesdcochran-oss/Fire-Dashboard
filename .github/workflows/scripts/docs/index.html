<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fire Weather — Six Counties (VA)</title>

  <script>
    tailwind = { config: { safelist: [
      'bg-red-600/10','text-red-700','ring-1','ring-red-600/20',
      'bg-orange-500/10','text-orange-700','ring-orange-500/20',
      'bg-amber-400/10','text-amber-700','ring-amber-400/20',
      'bg-emerald-500/10','text-emerald-700','ring-emerald-500/20',
      'bg-slate-300','text-slate-700'
    ]}};
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .num { text-align:right; font-variant-numeric: tabular-nums; }
    .badge { display:inline-flex; align-items:center; padding:2px 8px; border-radius:9999px;
             font-size:0.75rem; font-weight:600; line-height:1rem; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header class="mb-6 flex items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">Fire Weather Snapshot — VA Six Counties</h1>
        <p class="text-sm text-slate-600">Amelia, Nottoway, Dinwiddie, Prince George, Brunswick, Greensville</p>
      </div>
      <div class="text-right">
        <div id="lastRun" class="text-sm text-slate-600">Loading…</div>
        <button id="refreshBtn" class="mt-2 inline-flex items-center rounded-2xl bg-indigo-600 text-white px-3 py-1.5 shadow hover:bg-indigo-700">Refresh</button>
      </div>
    </header>

    <section id="banner" class="hidden mb-4 rounded-xl border border-amber-300 bg-amber-50 text-amber-900 p-3">
      <strong>Partial data:</strong> One or more sources failed. Displaying what we could fetch.
    </section>

    <div class="mb-4 flex items-center gap-2">
      <label class="text-sm text-slate-700">FIRMS MAP_KEY (optional):</label>
      <input id="firmsKey" type="password" placeholder="paste key" class="w-64 rounded-md border border-slate-300 px-2 py-1 text-sm" />
      <button id="firmsApply" class="text-sm rounded-md border border-slate-300 px-2 py-1 hover:bg-slate-100">Use</button>
      <span class="text-xs text-slate-500">If omitted, hotspot counts are skipped.</span>
    </div>

    <div class="overflow-x-auto rounded-2xl shadow bg-white">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-100 text-slate-700">
          <tr>
            <th class="p-3 text-left">County</th>
            <th class="p-3 num">Min RH (24h)</th>
            <th class="p-3 num">Max Wind mph (24h)</th>
            <th class="p-3 num">Peak Temp °F</th>
            <th class="p-3 num">Hotspots (24h, ±0.25°)</th>
            <th class="p-3 text-left">Risk</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <p class="mt-3 text-xs text-slate-500">
      Risk = 30/30/30 heuristic: Min RH ≤ 30%, Max Wind ≥ 30 mph, Peak Temp ≥ 86°F. 3→EXTREME, 2→HIGH, 1→ELEV, else MOD.
    </p>
  </div>

  <script src="_inline_fire_data.js"></script>
  <script>
    const counties = [
      { name:"Amelia",lat:37.340,lon:-77.977 },
      { name:"Nottoway",lat:37.142,lon:-78.051 },
      { name:"Dinwiddie",lat:37.078,lon:-77.612 },
      { name:"Prince George",lat:37.220,lon:-77.288 },
      { name:"Brunswick",lat:36.757,lon:-77.888 },
      { name:"Greensville",lat:36.693,lon:-77.540 },
    ];
    const bboxDelta = 0.25;
    const el = (id)=>document.getElementById(id);
    const fmtNum=(v,u="")=> (v==null||Number.isNaN(v))?"—":`${Math.round(v)}${u}`;
    function badge(text, level){
      const cls={
        EXTREME:"bg-red-600/10 text-red-700 ring-1 ring-red-600/20",
        HIGH:"bg-orange-500/10 text-orange-700 ring-1 ring-orange-500/20",
        ELEV:"bg-amber-400/10 text-amber-700 ring-1 ring-amber-400/20",
        MOD:"bg-emerald-500/10 text-emerald-700 ring-1 ring-emerald-500/20",
      }[level]||"bg-slate-300 text-slate-700";
      return `<span class="badge ${cls}">${text}</span>`;
    }
    function classify(minRH,maxWind,peakT){
      const c1=minRH!=null&&minRH<=30, c2=maxWind!=null&&maxWind>=30, c3=peakT!=null&&peakT>=86;
      const n=[c1,c2,c3].filter(Boolean).length;
      return n===3?{label:"EXTREME",score:3}:n===2?{label:"HIGH",score:2}:n===1?{label:"ELEV",score:1}:{label:"MOD",score:0};
    }
    function mphFromWindStr(str){
      if(!str) return null; const nums=(str.match(/\d+/g)||[]).map(n=>parseInt(n,10));
      return nums.length?Math.max(...nums):null;
    }
    async function fetchJson(url){ const r=await fetch(url,{headers:{"Accept":"application/ld+json, application/json"}}); if(!r.ok) throw new Error(r.status); return r.json();}
    async function getHourly(lat,lon){
      const p=await fetchJson(`https://api.weather.gov/points/${lat},${lon}`);
      const u=p?.properties?.forecastHourly; if(!u) throw new Error("No hourly URL");
      const h=await fetchJson(u); return h?.properties?.periods||[];
    }
    function summarize24h(ps){
      const cutoff=Date.now()+24*3600*1000; let minRH=null,maxWind=null,peakT=null;
      for(const p of ps){ if(new Date(p.startTime).getTime()>=cutoff) break;
        const rh=p.relativeHumidity?.value; const wind=mphFromWindStr(p.windSpeed)||mphFromWindStr(p.windGust); const t=p.temperature;
        if(typeof rh==='number') minRH=minRH==null?rh:Math.min(minRH,rh);
        if(typeof wind==='number') maxWind=maxWind==null?wind:Math.max(maxWind,wind);
        if(typeof t==='number') peakT=peakT==null?t:Math.max(peakT,t);
      } return {minRH,maxWind,peakT};
    }
    async function getFirmsCount(lat,lon,key){
      if(!key) return null;
      const minLon=lon-bboxDelta,maxLon=lon+bboxDelta,minLat=lat-bboxDelta,maxLat=lat+bboxDelta;
      const url=`https://firms.modaps.eosdis.nasa.gov/api/area/csv/${encodeURIComponent(key)}/VIIRS_SNPP_NRT/24h/${minLat},${minLon},${maxLat},${maxLon}`;
      try{ const r=await fetch(url); if(!r.ok) throw 0; const t=await r.text(); const lines=t.trim().split(/\r?\n/); const hdr=/latitude/i.test(lines[0]); return hdr?Math.max(0,lines.length-1):lines.length; }catch{ return null;}
    }
    async function build(){
      const tbody=el('tbody'); tbody.innerHTML=''; el('banner').classList.add('hidden'); const key=el('firmsKey').value.trim()||null;
      const jobs = counties.map(async c=>{
        const ps=await getHourly(c.lat,c.lon); const {minRH,maxWind,peakT}=summarize24h(ps); const hotspots=await getFirmsCount(c.lat,c.lon,key); const cls=classify(minRH,maxWind,peakT);
        return { county:c.name,minRH,maxWind,peakT,hotspots,cls };
      });
      const results=await Promise.allSettled(jobs);
      const rows=results.filter(r=>r.status==='fulfilled').map(r=>r.value);
      if(results.some(r=>r.status==='rejected')) el('banner').classList.remove('hidden');
      rows.sort((a,b)=>(b.cls.score-a.cls.score)||a.county.localeCompare(b.county));
      for(const r of rows){
        const tr=document.createElement('tr'); tr.className='border-b last:border-b-0';
        tr.innerHTML=`
          <td class="p-3 font-medium">${r.county}</td>
          <td class="p-3 num">${fmtNum(r.minRH,'%')}</td>
          <td class="p-3 num">${fmtNum(r.maxWind)}</td>
          <td class="p-3 num">${fmtNum(r.peakT)}</td>
          <td class="p-3 num">${r.hotspots==null?'—':r.hotspots}</td>
          <td class="p-3">${badge(r.cls.label,r.cls.label)}</td>`;
        tbody.appendChild(tr);
      }
      const ts = new Date().toLocaleString('en-US',{timeZone:'America/New_York',hour12:true});
      el('lastRun').textContent=`Updated: ${ts} ET`;
    }
    el('refreshBtn').addEventListener('click',build);
    el('firmsApply').addEventListener('click',build);
    build();
  </script>
</body>
</html>
